<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />

<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>(ARCOS) WepSIM</title>

    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=yes, initial-scale=1, maximum-scale=2.2, minimum-scale=1, width=device-width">

    <script src="external/jquery.min.js"></script>
    <script src="external/jquery-ui.min.js"></script>
    <script>
        $(document).bind("mobileinit", function() {
            $.mobile.defaultPageTransition = "none";
            $.mobile.defaultDialogTransition = "none";
        });
    </script>
    <script src="external/jquery.mobile-1.4.5.min.js"></script>

    <link rel="stylesheet" href="external/jquery.mobile-1.4.5.min.css">
    <style>
    .ui-panel-inner {
        position: absolute;
        top: 1px;
        left: 0;
        right: 0;
        bottom: 0px;
        overflow: scroll;
        -webkit-overflow-scrolling: touch;
    }

    textarea.ui-input-text { 
        height: inherit !important
    }

    .ui-icon-reset:after {
	background-image: url("images/reset.svg");
        background-repeat: no-repeat;
        background-size: 15px 15px;
    }
    </style>

    <link  href="external/external.min.css" rel="stylesheet">
    <script src="external/external.min.js"></script>

    <script src="min.sim_all.js"></script>
    <script src="min.sim_hw.js"></script>

    <script>
    //
    // Assembly
    //

    function showError ( Msg ) 
    {
            var errorMsg = Msg.replace(/\t/g,' ').replace(/   /g,' ');

            var pos = errorMsg.match(/Problem around line \d+/);
            var lineMsg = '' ;
            if (null != pos) {
                pos = parseInt(pos[0].match(/\d+/)[0]);
                lineMsg += '<button type="button" class="btn btn-danger" ' + 
                           '        onclick="$.notifyClose();' +
                           '                            var marked = inputasm.addLineClass(' + (pos-1) + ', \'background\', \'CodeMirror-selected\');' +
                           '                 setTimeout(function() { inputasm.removeLineClass(marked, \'background\', \'CodeMirror-selected\'); }, 2000);' +
		           '		     var t = inputasm.charCoords({line: ' + pos + ', ch: 0}, \'local\').top;' +
		           '		     var middleHeight = inputasm.getScrollerElement().offsetHeight / 2;' +
		           '		     inputasm.scrollTo(null, t - middleHeight - 5);">Go line ' + pos + '</button>&nbsp;' ;
            }

	    $.notify({ title: '<strong>ERROR</strong>', 
                       message: errorMsg + '<br>' + 
                                '<center>' +  
                                lineMsg + 
                                '<button type="button" class="btn btn-danger" onclick="$.notifyClose();">Close</button>' + 
                                '</center>' },
		     { type: 'danger', newest_on_top: true, delay: 0, placement: { from: 'top', align: 'center' } });
    }

    function compileAssembly ( show_binary ) 
    {
        // get Assembly
        var textToConvert = inputasm.getValue() ;

        // get SIMWARE.firmware
        var SIMWARE = get_simware() ;
	if (SIMWARE.firmware.length == 0) {
            alert('WARNING: please load the microcode first.');
            $.mobile.pageContainer.pagecontainer('change','#main3');
            return false;
	} 

        // compile Assembly and show message
        var SIMWAREaddon = simlang_compile(textToConvert, SIMWARE);
        if (SIMWAREaddon.error != null) {
            showError(SIMWAREaddon.error) ;
            return false;
        }

	$.notify({ title: '<strong>INFO</strong>', message: 'Assembly was compiled and loaded.'},
		 { type: 'success', newest_on_top: true, delay: get_cfg('NOTIF_delay'), placement: { from: 'top', align: 'center' } });

        // update memory and segments
        set_simware(SIMWAREaddon) ;
	update_memories(SIMWARE);

        // update UI 
        if (true == show_binary)
        {
           $("#compile_results").html("<center>" +
                                      "<br>Loading binary, please wait..." +
                                      "<br><br>WARNING: loading binary might take time on slow mobile devices.</center>");
           $("#compile_results").css({width:"100%",height:"inherit !important"});
	   $('#bin1').popup('open');

	   setTimeout(function(){ showCompiledAssembly(); }, 500);
        }

        $("#asm_debugger").html(assembly2html(SIMWAREaddon.mp, 
                                              SIMWAREaddon.labels2, 
                                              SIMWAREaddon.seg, 
                                              SIMWAREaddon.assembly));

	reset();
        return true;
    }

    function showCompiledAssembly () 
    {
        var SIMWARE = get_simware() ;

        $("#compile_results").html(mp2html(SIMWARE.mp, SIMWARE.labels2, SIMWARE.seg));
        $("#bin1").popup("reposition", {positionTo: 'window'});

        for (skey in SIMWARE.seg) {
             $("#compile_begin_" + skey).html("0x" + SIMWARE.seg[skey].begin.toString(16));
             $("#compile_end_"   + skey).html("0x" + SIMWARE.seg[skey].end.toString(16));
        }
    }

    function load_assembly_from_file() 
    {
        var fileToLoad = document.getElementById("fileToLoad2").files[0];
        var fileReader = new FileReader();
        fileReader.onload  = function (fileLoadedEvent) {
                                            var textFromFileLoaded = fileLoadedEvent.target.result;
					    inputasm.setValue(textFromFileLoaded);
                             };
	fileReader.onerror = function(e) {
			        console.error("File could not be read! Code " + e.target.error.code);
			     };
        fileReader.readAsText(fileToLoad, "UTF-8");
    }

    function load_assembly_from_example ( )
    {
	var xmlhttp = new XMLHttpRequest();
	var url = "examples/exampleCode.txt?time=20160720a" ;

	xmlhttp.onreadystatechange=function() {
					if ((xmlhttp.readyState == 4) && ((xmlhttp.status == 200) || (xmlhttp.status == 0)))
					{
                                            var textFromFileLoaded = xmlhttp.responseText ;
					    inputasm.setValue(textFromFileLoaded);
					}
				   }
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
    }


    //
    // Firmware
    //

    function compileFirmware ( show_binary ) 
    {
        var textFromFileLoaded = inputfirm.getValue() ;

	var preSM = load_firmware(textFromFileLoaded) ;
	if (preSM.error != null) {
            showError(preSM.error) ;
            return false;
        }

	$.notify({ title: '<strong>INFO</strong>', message: 'Microcode was compiled and loaded.'},
		 { type: 'success', newest_on_top: true, delay: get_cfg('NOTIF_delay'), placement: { from: 'top', align: 'center' } });

        // update UI 
        if (true == show_binary)
        {
           $("#compile_results").html("<center>" +
                               "<br>Loading binary, please wait..." +
                               "<br><br>WARNING: loading binary might take time on slow mobile devices.</center>");
           $("#compile_results").css({width:"100%",height:"inherit !important"});
	   $('#bin1').popup('open');

	   setTimeout(function(){ showCompiledFirmware(); }, 500);
        }

	reset() ;
        return true;
    }

    function showCompiledFirmware () 
    {
        var SIMWARE = get_simware() ;
        $("#compile_results").html(firmware2html(SIMWARE.firmware, true));
	$("#compile_results").css({width:"inherit !important", height:"inherit !important"});

	$("#bin1").enhanceWithin();
	$('#bin1').trigger('updatelayout');
        $("#bin1").popup("reposition", {positionTo: 'window'});
	$('#bin1').trigger('refresh');
    }

    function load_firmware_from_file ( )
    {
        var fileToLoad = document.getElementById("fileToLoad").files[0];
        var fileReader = new FileReader();
        fileReader.onload = function (fileLoadedEvent) {
                                            var textFromFileLoaded = fileLoadedEvent.target.result;
					    inputfirm.setValue(textFromFileLoaded);
                                };
	fileReader.onerror = function(e) {
			        console.error("File could not be read! Code " + e.target.error.code);
			     };
        fileReader.readAsText(fileToLoad, "UTF-8");
    }

    function load_firmware_from_example ( )
    {
	var xmlhttp = new XMLHttpRequest();
	var url = "examples/exampleMicrocode.txt?time=20160720a" ;

	xmlhttp.onreadystatechange=function() {
					// if (xmlhttp.readyState == 4 && xmlhttp.status == 200) 
					if ((xmlhttp.readyState == 4) && ((xmlhttp.status == 200) || (xmlhttp.status == 0)))
					{
                                            var textFromFileLoaded = xmlhttp.responseText ;
					    inputfirm.setValue(textFromFileLoaded);
					}
				   }
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
    }


    //
    // UI
    //

    function save_as_file ( contentInputName, filenameInputName )
    {
          //var textToWrite = document.getElementById(contentInputName).value;
            var textToWrite = contentInputName.getValue();
            var textFileAsBlob = new Blob([textToWrite], { type: 'text/plain' });
            var fileNameToSaveAs = document.getElementById(filenameInputName).value;

            var downloadLink = document.createElement("a");
            downloadLink.download = fileNameToSaveAs;
            downloadLink.innerHTML = "Download File";
            if (window.webkitURL != null) {
                // Chrome allows the link to be clicked
                // without actually adding it to the DOM.
                downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
            }
            else {
                // Firefox requires the link to be added to the DOM
                // before it can be clicked.
                downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
                downloadLink.onclick = function ( event ) {
                                            document.body.removeChild(event.target);
                                       };
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
            }

            downloadLink.click();
    }

    function toggle_play ( btn1 )
    {
        if (DBG_stop == false) {
            DBG_stop = true ;
        } else {
            DBG_stop = false ;
            asmdbg_play(btn1) ;
        }
    }

    function show_help1 ( )
    {
        var rel = $('#help1_ref').data('relative') ;
        if (rel == "")
            return;

        $('#iframe_help1').load('help/simulator-' + get_cfg('ws_idiom') + '.html ' + rel,
			        function() {
                                    $('#help1').trigger('updatelayout'); 
                                    $('#help1').popup('open');
                                });
    }

    function sim_init ( )
    {
	    var ref_p = document.getElementById('svg_p').contentDocument ;
	    if (ref_p != null)
            {
                var o  = ref_p.getElementById('text3495');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab11').trigger('click');
                                                  }, false);
	        var o  = ref_p.getElementById('text3029');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab11').trigger('click');
                                                  }, false);
	        var o  = ref_p.getElementById('text3031');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab11').trigger('click');
                                                  }, false);
	        var o  = ref_p.getElementById('text3001');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab14').trigger('click');
                                                  }, false);
	        var o  = ref_p.getElementById('text3183');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab23').trigger('click');
                                                  }, false);
	        var o  = ref_p.getElementById('text3775');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab15').trigger('click');
                                                  }, false);
	        var o  = ref_p.getElementById('text3829');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab12').trigger('click');
                                                  }, false);
	        var o  = ref_p.getElementById('text3845');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab12').trigger('click');
                                                  }, false);
                var o  = ref_p.getElementById('text3459-7');
                if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     execute_microinstruction(); 
                                                  }, false);
            }

	    var ref_cu = document.getElementById('svg_cu').contentDocument ;
	    if (ref_cu != null)
            {
	        var o  = ref_cu.getElementById('text3010');
	        if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab16').trigger('click');
                                                  }, false);
                var o  = ref_cu.getElementById('text3346-5');
                if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     $('#tab22').trigger('click');
                                                  }, false);
                var o  = ref_cu.getElementById('text4138');
                if (o != null) o.addEventListener('click', 
                                                  function() { 
                                                     execute_microinstruction(); 
                                                  }, false);
            }
    }
    </script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-80849772-1', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- End Google Analytics -->
</head>


<body>


<div data-role="page" id="main1">

	<div data-role="header" data-position="fixed" data-disable-page-zoom="false" data-theme="a">
                <div id="button_bar" data-role="controlgroup" data-type="horizontal" class="ui-btn-left">
                    <a href="#about1" data-rel="popup" data-position-to="window"><img src="images/arcos.svg" height="40"></a>
                </div>
                <span class="ui-title"><b>WepSIM</b> <span class="badge"><div class="wsversion">X</div></span> / Simulator</span>
		<div id="action_bar" data-role="controlgroup" data-type="horizontal" class="ui-btn-right">
                    <a href="#actions_panel" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b">Menu</a>
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content">

            <div class="row">
                <div class="col-md-8" style="padding: 0 2px 0 5px;">
		    <div data-role="tabs" id="tabs2">
    		      <div data-role="navbar" id="tabsnav2" class="ui-responsive">
		        <ul>
		          <li style="clear:none;width:30% !important">
                              <a id="tab23" href="#eltos_cu"   
                                 onclick="start_drawing(); refresh();">Control Unit</a>
                          </li>
		          <li style="clear:none;width:20% !important">
                              <a id="tab22" href="#eltos_p"   class="ui-btn-active"
                                 onclick="start_drawing(); refresh();">CPU</a>
                          </li>
		          <li style="clear:none;width:49% !important">
                              <a id="tab24" href="#eltos_dbg"  
                                 onclick="stop_drawing();">Assembly Debugger</a>
                          </li>
		        </ul>
		      </div>
		      <div id="eltos_p"  class="ui-body-d ui-content" style="padding: 5px 0 5px 0;">
			    <object id="svg_p" data="images/processor5.svg" type="image/svg+xml">
				Your browser doesn't support SVG
			    </object>
                            <img id="internalbus_fire" src="images/fire.gif" height=50 style="position:absolute; top:57%; left:8%;  display:none;">
                            <img id="databus_fire"     src="images/fire.gif" height=50 style="position:absolute; top:23%; left:25%; display:none;">
		      </div>
		      <div id="eltos_cu"  class="ui-body-d ui-content">
			    <object id="svg_cu" data="images/controlunit5.svg" type="image/svg+xml">
				Your browser doesn't support SVG
			    </object>
		      </div>
		      <div id="eltos_dbg"  class="ui-body-d ui-content">
			   <center>
		   	   <table class='table ui-responsive ui-table' style="margin-bottom: 0px;">
		   	   <thead>
			   <tr>
			   <th width=10%>break<span class="hidden-xs">points</span></th>
			   <th width=15%>address</th>
                           <th width=10%>&nbsp;</th>
                           <th width=29%>assembly</th>
                           <th width=10% class='hidden-xs'>&nbsp;</th>
                           <th width=25% class='hidden-xs'>pseudo-instructions</th>
			   </tr>
			   </thead>
			   </table>
			   </center>

		           <div style="overflow-y:auto; overflow-x:auto; height:70% !important;">
                                <div id="asm_debugger">
                                <br>
                                <ol>
                                <li>Load the microcode to be used.</li>
                                    <ul>
                                    <li>You can use the default example of microcode, load it from a file or you can edit one.</li>
                                    </ul>
                                <br>
                                <li>Load the assembly to be used.</li>
                                    <ul>
                                    <li>You can use the default assembly example, load it from a file or you can edit one.</li>
                                    </ul>
                                <br>
                                <li>Come back to the simulator in order to execute step by step the microcode+assembly loaded before.</li>
                                    <ul>
                                    <li>Each step could be executed at microinstruction or instruction level.</li>
                                    </ul>
                                </ol>
                                </div>
		           </div>
		      </div>
	    	    </div>
                </div>

                <div class="col-md-4" style="padding: 0 8px 0 0px;">

                    <div class="btn-toolbar" role="toolbar" id="sim_toolbar" style="padding: 0 0px 10px 0px;">
			<div class="btn-group btn-group-justified" role="group">
			    <a          href="#" style="background-color: #CCCCCC"
			       class="ui-btn btn-group ui-corner-all ui-btn-inline ui-btn-a ui-icon-reset   ui-btn-icon-top ui-mini"
			       onclick="reset();">Reset</a>
			    <a          href="#" style="background-color: #CCCCCC"
			       class="ui-btn btn-group ui-corner-all ui-btn-inline ui-btn-a ui-icon-arrow-r ui-btn-icon-top ui-mini"
			       onclick="execute_microinstruction();">&#181;Instruction</a>
			    <a          href="#" style="background-color: #CCCCCC"
			       class="ui-btn btn-group ui-corner-all ui-btn-inline ui-btn-a ui-icon-arrow-r ui-btn-icon-top ui-mini"
			       onclick="execute_instruction();">Instruction</a>
			    <a id="qbp" href="#" style="background-color: #CCCCCC"
			       class="ui-btn btn-group ui-corner-all ui-btn-inline ui-btn-a ui-icon-carat-r ui-btn-icon-top ui-mini"
			       onclick="toggle_play('#qbp'); return false;">Run</a>
			    <a id="ib1" href="#" style="background-color: #D4DB17; -webkit-text-shadow: none; text-shadow: none;"
			       class="ui-btn btn-group ui-corner-all ui-btn-inline ui-btn-a ui-icon-info ui-btn-icon-top ui-mini"
			       onclick="$('#help1_ref').data('relative','#help_simulator_screens'); show_help1();">Help</a>
                        </div>
                    </div>

		    <div data-role="tabs" id="tabs1">
    		      <div data-role="navbar" id="tabsnav1" class="ui-responsive">
		        <ul>
		          <li style="clear:none;width:33% !important"><a id="tab14" href="#mp" class="ui-btn-active">Memory</a></li>
		          <li style="clear:none;width:33% !important"><a id="tab15" href="#io">I/O</a></li>
		          <li class="ui-block-a" style="clear:none;width:33% !important;border:1px solid #ddd;"><a id="tab12" href="#con">Console</a></li>
                          <br>
		          <li style="           width:33% !important"><a id="tab11" href="#all">Registers</a></li>
		          <li style="clear:none;width:33% !important"><a id="tab16" href="#mc">Control Memory</a></li>
		          <li style="clear:none;width:33% !important"><a id="tab13" href="#config">Configuration</a></li>
		        </ul>
		      </div>
		      <div id="all"  class="ui-body-d ui-content" style="padding: 15 0px 0 0px;">
		         <div id="states_ALL"          style="width: inherit; overflow-y: auto;"></div>
			 <br style="height:0; width:100%; font-size:0; margin:5; padding:0; border:0; display:block;">
		         <div id="states_BR"           style="width: inherit; overflow-y: auto;"></div>
		      </div>
	    	      <div id="config"  class="ui-body-d ui-content">
		         <div id="config_ALL"          style="width: inherit; overflow-y: auto;"></div>
		      </div>
		      <div id="mp"   class="ui-body-d ui-content">
		         <div id="memory_MP"           style="height:60vh; width: inherit; overflow-y: scroll;"></div>
		      </div>
		      <div id="mc"   class="ui-body-d ui-content">
		         <div id="memory_MC"           style="height:60vh; width: inherit; overflow-y: scroll;"></div>
		      </div>
		      <div id="con"  class="ui-body-d ui-content">
                         <img height=55 src="images/monitor2.png">
		         <textarea style="min-width:90%; overflow-y:auto;" placeholder="ARCOS" id="kdb_con" rows=10></textarea>
                         <img height=35 src="images/keyboard1.png">
		         <textarea style="min-width:90%; overflow-y:auto;" placeholder="ARCOS" id="kdb_key" rows=2></textarea>
		      </div>
		      <div id="io"  class="ui-body-d ui-content">
		         <div id="io_ALL"              style="width: inherit; overflow-y: auto;"></div>
		      </div>
	    	    </div>
                </div>
            </div>

	</div><!-- /content -->

</div><!-- /page -->


<div data-role="page" id="main3">

	<div data-role="header" data-position="fixed" data-disable-page-zoom="false" data-theme="a">
                <div id="button_bar" data-role="controlgroup" data-type="horizontal" class="ui-btn-left">
                    <a href="#about1" data-rel="popup" data-position-to="window"><img src="images/arcos.svg" height="40"></a>
                </div>
                <span class="ui-title"><b>WepSIM</b> <span class="badge"><div class="wsversion">X</div></span> / Microcode</span>
		<div id="action_bar" data-role="controlgroup" data-type="horizontal" class="ui-btn-right">
                    <a href="#actions_panel" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b">Menu</a>
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content">

		<div id="lsload" 
                     data-role="popup" data-overlay-theme="a" data-theme="a" data-dismissible="false">
		    <div data-role="header" data-theme="a">
		    <h1>Microcode</h1>
		    </div>
		    <div role="main" class="ui-content">
			<h3>Please select the file to be loaded:</h3>
			<p><input type="file" id="fileToLoad" /></p>
			<center>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
                        <button class="ui-btn ui-btn-b ui-btn-inline" 
                                onclick="load_firmware_from_file();
                                         $('#lsload').popup('close');">Load from File</button>
                        </center>
		    </div>
		</div>

		<div id="lssave" 
                     data-role="popup" data-overlay-theme="a" data-theme="a" data-dismissible="false">
		    <div data-role="header" data-theme="a">
		    <h1>Save Page</h1>
		    </div>
		    <div role="main" class="ui-content">
			<h2>Please write the file name where Microcode will be saved:</h2>
			<p><input id="inputFileNameToSaveAs" style="min-width: 90%;"/></p>
			<center>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
                        <button class="ui-btn ui-btn-b ui-btn-inline" 
                                onclick="var SIMWARE = get_simware() ;
                                         var simware_as_text = saveFirmware(SIMWARE);
                                         if (simware_as_text.trim() == '') {
					     alert('The Microcode loaded in memory is empty!\n' + 
                                                   'Please load a Microcode first in memory in order to save it.');
					 }
					 else {
                                           //document.getElementById('inputFirmware').value = simware_as_text ;
					     inputfirm.setValue(simware_as_text);
                                             save_as_file(inputfirm, 'inputFileNameToSaveAs');
					 }">Save to File</button>
                        </center>
		    </div>
		</div>

                <div class="btn-toolbar" role="toolbar">
                <div class="btn-group btn-group-justified" role="group">
		            <a href="#lsload" style="background-color: #CCCCCC"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-back    ui-btn-icon-left ui-mini col-xs-3 col-md-1 col-lg-1"
				   data-rel="popup" data-position-to="window" data-transition="pop">Load</a>
		            <a href="#lssave" style="background-color: #CCCCCC"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-forward ui-btn-icon-left ui-mini col-xs-3 col-md-1 col-lg-1"
				   data-rel="popup" data-position-to="window" data-transition="pop">Save</a>
		            <a href="#"       style="background-color: #CCCCCC"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-refresh ui-btn-icon-left ui-mini col-xs-4 col-md-1 col-lg-1"
				   data-transition="none" data-inline="true"
				   onclick="compileFirmware(false);">&#181;compile</a>
		            <a href="#"       style="background-color: #CCCCCC"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-refresh ui-btn-icon-left ui-mini col-xs-9 col-md-2 col-lg-2"
				   data-transition="none" data-inline="true"
				   onclick="var ok = compileFirmware(false);
                                            if (true == ok) {
                                                $.mobile.pageContainer.pagecontainer('change','#main4');
                                            }">&#181;compile and go assembly</a>

		            <a href="#" style="background-color: #DDDDDD"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-arrow-u ui-btn-icon-left ui-mini col-xs-9 col-md-2 col-lg-2 ui-shadow"
				   onclick="compileFirmware(true);">Show co2&#181;addr + control memory</a>

                            <a href="#" style="background-color: #D4DB17"
                                   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-info     ui-btn-icon-left  ui-mini col-xs-3 col-md-1 col-lg-1"
				   onclick="$('#help1_ref').data('relative','');
                                            $('#iframe_help1').html('<object id=svg_p2 data=\'images/cpu5.svg?time=20160720a\' type=image/svg+xml>Your browser does not support SVG</object>');
                                            $('#help1').trigger('updatelayout');
                                            $('#help1').popup('reposition', {positionTo: 'window'});
					    $('#help1').popup('open');"
                                   >Hardware Summary</a>
                            <a href="#" style="background-color: #D4DB17"
                                   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-info    ui-btn-icon-left ui-mini col-xs-3 col-md-1 col-lg-1"
				   onclick="$('#help1_ref').data('relative','#help_firmware_format'); show_help1();"
                                   >Help</a>
		            <a href="#" style="background-color: #DDDDDD"
				   class="ui-btn navbar-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a ui-icon-bars    ui-btn-icon-left ui-mini col-xs-4 col-md-1 col-lg-1"
				   onclick="load_firmware_from_example();"
                                   >Example</a>
		</div>
		</div>

		<div id="t3_firm"  class="ui-body-d ui-content" style="position:relative;">
		     <textarea style="min-width:90%; overflow-y:auto;"
                               placeholder="Please select 'Example' or 'Load' first in order to have an initial Microcode."
                               id="inputFirmware" rows=20></textarea>
		</div>

	</div><!-- /content -->

</div><!-- /page -->


<div data-role="page" id="main4">

	<div data-role="header" data-position="fixed" data-disable-page-zoom="false" data-theme="a">
                <div id="button_bar" data-role="controlgroup" data-type="horizontal" class="ui-btn-left">
                    <a href="#about1" data-rel="popup" data-position-to="window"><img src="images/arcos.svg" height="40"></a>
                </div>
                <span class="ui-title"><b>WepSIM</b> <span class="badge"><div class="wsversion">X</div></span> / Assembly</span>
		<div id="action_bar" data-role="controlgroup" data-type="horizontal" class="ui-btn-right">
                    <a href="#actions_panel" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b">Menu</a>
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content">

		<div id="lsload2" 
                     data-role="popup" data-overlay-theme="a" data-theme="a" data-dismissible="false">
		    <div data-role="header" data-theme="a">
		    <h1>Assembler</h1>
		    </div>
		    <div role="main" class="ui-content">
			<h3>Please select the file to be assembled:</h3>
			<p><input type="file" id="fileToLoad2" /></p>
			<center>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
                        <button class="ui-btn ui-btn-b ui-btn-inline" 
                                onclick="load_assembly_from_file();
                                         $('#lsload2').popup('close');">Load from File</button>
                        </center>
		    </div>
		</div>

		<div id="lssave2" 
                     data-role="popup" data-overlay-theme="a" data-theme="a" data-dismissible="false">
		    <div data-role="header" data-theme="a">
		    <h1>Save Page</h1>
		    </div>
		    <div role="main" class="ui-content">
			<h2>Please write the file name where assembly will be saved:</h2>
			<p><input id="inputFileNameToSaveAs2" style="min-width: 90%;"/></p>
			<center>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
                        <button class="ui-btn ui-btn-b ui-btn-inline" 
                                onclick="save_as_file(inputasm,'inputFileNameToSaveAs2');">Save to File</button>
                        </center>
		    </div>
		</div>

                <div class="btn-toolbar" role="toolbar">
                <div class="btn-group btn-group-justified" role="group">
		            <a href="#lsload2" style="background-color: #CCCCCC"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-back     ui-btn-icon-left ui-mini col-xs-3 col-md-1 col-lg-1"
				   data-rel="popup" data-position-to="window" data-transition="pop" data-inline="true">Load</a>
		            <a href="#lssave2" style="background-color: #CCCCCC"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-forward  ui-btn-icon-left ui-mini col-xs-3 col-md-1 col-lg-1"
				   data-rel="popup" data-position-to="window" data-transition="pop" data-inline="true">Save</a>
		            <a href="#" style="background-color: #CCCCCC"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-refresh  ui-btn-icon-left ui-mini col-xs-4 col-md-1 col-lg-1"
				   data-transition="none" data-inline="true"
				   onclick="compileAssembly(false);">Compile</a>
		            <a href="#" style="background-color: #CCCCCC"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-refresh  ui-btn-icon-left ui-mini col-xs-9 col-md-2 col-lg-2"
				   data-transition="none" data-inline="true"
				   onclick="var ok = compileAssembly(false);
                                            if (true == ok) {
                                                $.mobile.pageContainer.pagecontainer('change','#main1');
                                            }">Compile and go simulator</a>

		            <a href="#" style="background-color: #DDDDDD"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-arrow-u  ui-btn-icon-left ui-mini col-xs-9 col-md-2 col-lg-2 ui-shadow"
				   onclick="compileAssembly(true);">Show Main Memory</a>

                            <a href="#" style="background-color: #D4DB17"
                                   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-info     ui-btn-icon-left  ui-mini col-xs-5 col-md-1 col-lg-1"
				   onclick="$('#help1_ref').data('relative','#help_assembly_format'); show_help1();">Help</a>

		            <a href="#" style="background-color: #DDDDDD"
                                   onclick="load_assembly_from_example();"
				   class="ui-btn navbar-btn ui-corner-all ui-btn-inline ui-btn-a ui-icon-bars     ui-btn-icon-left ui-mini col-xs-5 col-md-1 col-lg-1 ui-shadow"
				   data-inline="true">Example</a>
		</div>
		</div>

		<div id="t4_asm"   class="ui-body-d ui-content">
		        <textarea style="min-width:90%; overflow-y:auto;"
                                  placeholder="Please select 'Load' first to have the assembly code to work with."
			          id="inputAssembly" rows="20"></textarea>
		</div>

	</div><!-- /content -->

</div><!-- /page -->


<div data-role="panel" id="actions_panel" data-display="overlay" data-position="right" data-theme="a" 
     style="width:20em; min-width:17em;">

	<div data-role="collapsible-set">
	    <div data-role="collapsible" data-collapsed="false" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d">
	    <h3>WorkSpaces</h3>
	    <p>
	    <ul id="listview_1" data-role="listview" data-inset="false" data-theme="a" data-divider-theme="b">
		    <li><a id="tab21" href="#" style="background-color: lightgray"
			   onclick="$.mobile.pageContainer.pagecontainer('change','#main3');"><h2>Microcode</h2></a></li>
		    <li><a id="tab24" href="#" style="background-color: lightgray"
			   onclick="$.mobile.pageContainer.pagecontainer('change','#main4');"><h2>Assembly</h2></a></li>
		    <li><a id="tab25" href="#" style="background-color: lightgray"
			   onclick="$.mobile.pageContainer.pagecontainer('change','#main1');"><h2>Simulator</h2></a></li>
	    </ul>
            </p>
	    </div>

	    <div data-role="collapsible" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d">
	    <h3>Help</h3>
	    <p>
	    <ul id="listview_2" data-role="listview" data-inset="false" data-theme="a" data-divider-theme="b" data-mini="true">
		    <li><a href="#" class="ui-btn ui-btn-icon-left ui-icon-info" style="background-color: #D4DB17;"
			   onclick="$('#help1_ref').data('relative','#help_simulator_screens');
			            show_help1();"><h2>Simulator usage</h2></a></li>
		    <li><a href="#" class="ui-btn ui-btn-icon-left ui-icon-info" style="background-color: #D4DB17;"
			   onclick="$('#help1_ref').data('relative','#help_firmware_format');
			            show_help1();"><h2>Microcode format</h2></a></li>
		    <li><a href="#" class="ui-btn ui-btn-icon-left ui-icon-info" style="background-color: #D4DB17;"
			   onclick="$('#help1_ref').data('relative','#help_assembly_format');
			            show_help1();"><h2>Assembly format</h2></a></li>
		    <li><a href="#" class="ui-btn ui-btn-icon-left ui-icon-info" style="background-color: #D4DB17;"
			   onclick="$('#help1_ref').data('relative','#help_simulator_arch');
			            show_help1();"><h2>Simulator architecture</h2></a></li>
	    </ul>
            </p>
	    </div>

	    <div data-role="collapsible" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d">
	    <h3>Configuration</h3>
	    <p>
	    <ul id="listview_3" data-role="listview" data-inset="false" data-theme="a" data-divider-theme="b">
		    <li class="list-group-item">
			 Speed-up (slow - fast):
			 <input type="range"
				data-show-value="false"
				name="slider1" id="slider1"
				min="1" max="100" value="100" step=1
				onchange="set_cfg('DBG_delay', 1000 / this.value); save_cfg();">
			 <fieldset data-role="controlgroup" data-type="horizontal">
			 Single step element:
			 <ul>
			 <li>
			     <input name="radio1" id="radio1-instruction" data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('DBG_level','instruction'); save_cfg();"
				    value="on" type="radio">
			     <label for="radio1-instruction">Instruc.</label>
			     <input name="radio1" id="radio1-microinstruction" data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('DBG_level','microinstruction'); save_cfg();"
				    value="off" type="radio">
			     <label for="radio1-microinstruction">&#181;instruc.</label>
			 </li>
			 </ul>
			 </fieldset>
		    </li>
		    <li class="list-group-item">
<div class="ui-grid-solo">
<div class="ui-block-a">
			 <fieldset data-role="controlgroup" data-type="horizontal">
			 RF display format:<br>
			 <ul>
			 <li>
			     <input name="radio2" id="radio2-16" data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('RF_display_format',16); show_rf_values(); show_memories_values(); save_cfg();"
				    value="on" type="radio">
			     <label for="radio2-16">Hex.</label>
			     <input name="radio2" id="radio2-10" data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('RF_display_format',10); show_rf_values(); show_memories_values(); save_cfg();"
				    value="off" type="radio">
			     <label for="radio2-10">Dec.</label>
			     <input name="radio2" id="radio2-8"  data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('RF_display_format',8); show_rf_values(); show_memories_values(); save_cfg();"
				    value="off" type="radio">
			     <label for="radio2-8">Oct.</label>
			 </li>
			 </ul>
			 </fieldset>
</div>
</div>
<div class="ui-grid-solo">
<div class="ui-block-a">
			 <fieldset data-role="controlgroup" data-type="horizontal">
			 RF name nomenclature:<br>
			 <ul>
			 <li>
			     <input name="radio3" id="radio3-numerical" data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('RF_display_name','numerical'); show_rf_names(); save_cfg();"
				    value="on" type="radio">
			     <label for="radio3-numerical">Numbers</label>
			     <input name="radio3" id="radio3-logical" data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('RF_display_name','logical'); show_rf_names(); save_cfg();"
				    value="off" type="radio">
			     <label for="radio3-logical">Labels</label>
			 </li>
			 </ul>
			 </fieldset>
</div>
</div>
		    </li>
		    <li class="list-group-item input-toggles">
			 Data-path Color:
			 <ul>
			 <input type="color"
                                id="colorpicker1"
				data-show-value="false"
                                class="noshadow"
				onchange="set_cfg('color_data_active', $('#colorpicker1').spectrum('get')); refresh(); save_cfg();">
			 </ul>
			 Signal Color:
			 <ul>
			 <input type="color"
                                id="colorpicker2"
				data-show-value="false"
                                class="noshadow"
				onchange="set_cfg('color_name_active', $('#colorpicker2').spectrum('get')); refresh(); save_cfg();">
			 </ul>
<div class="ui-grid-solo">
<div class="ui-block-a">
			 <fieldset data-role="controlgroup" data-type="horizontal">
			 Interactive Mode:<br>
			 <ul>
			 <li>
			     <input name="radio5" id="radio5-true" data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('is_interactive',true); save_cfg();"
				    value="on" type="radio">
			     <label for="radio5-true">On</label>
			     <input name="radio5" id="radio5-false" data-mini="true"
                                    style="margin-top:-8px"
				    onclick="set_cfg('is_interactive',false); save_cfg();"
				    value="off" type="radio">
			     <label for="radio5-false">Off</label>
			 </li>
			 </ul>
			 </fieldset>
</div>
</div>
		    </li>
	    </ul>
            </p>
	    </div>
	</div>

</div><!-- /panel -->


<div data-role="popup" id="about1" 
     data-theme="a" data-dismissible="false" data-animate="false" data-overlay-theme="b">

   <div data-role="header" data-theme="a">
   <h1><b>WepSIM</b> <span class="badge btn-success"><div class="wsversion">X</div></span> </h1>
   </div>
   <div role="main" class="ui-content">

        <div style="font-family: Helvetica Neue,Helvetica,Arial,sans-serif; font-size: 16px; line-height: 24px; padding-bottom: 6.4px; padding-left: 8px; padding-right: 8px; padding-top: 6.4px;">
        <div class="row">
        <div class="col-xs-12 col-sm-12">
            Copyright &copy; 2015-2016 <small>Javier Prieto Cepeda, Sa&uacute;l Alonso Monsalve, F&eacute;lix Garc&iacute;a Carballeira, and Alejandro Calder&oacute;n Mateos</small>
            <p>
        </div>
        <div class="col-xs-12 col-sm-12" style="max-height:50vh; overflow-y: scroll;">
		<div class="col-xs-12 col-sm-12">
		    <b>WepSIM (Web elemental processor SIMulator)</b> is free software: you can redistribute it and/or modify
		    it under the terms of the GNU Lesser General Public License as published by
		    the Free Software Foundation, either version 3 of the License, or
		    (at your option) any later version.
		    See <a rel="external" href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.
		    <p>
		</div>
		<div class="col-xs-12 col-sm-12">
		    <b>WepSIM</b> uses different technologies such as
		    <a rel="external" href="https://jquerymobile.com/">Jquery Mobile</a>,
		    <a rel="external" href="http://knockoutjs.com/">Knockout</a>,
		    <a rel="external" href="http://getbootstrap.com/">Bootstrap</a>,
		    <a rel="external" href="http://bootboxjs.com/">Bootbox</a>,
		    <a rel="external" href="http://codemirror.net/index.html">CodeMirror</a> Editor,
		    <a rel="external" href="https://bgrins.github.io/spectrum/">spectrum</a> ColorPicker,
		    and the <a rel="external" href="https://github.com/mouse0270/bootstrap-notify">Bootstrap Notify</a>.
		    <p>
		</div>
		<div class="col-xs-12 col-sm-12">
		    More information: <a rel="external" href="http://www.arcos.inf.uc3m.es/~ec-2ed/">http://www.arcos.inf.uc3m.es/~ec-2ed/</a><br>
		    <p>
		</div>
        </div>
        <div class="col-xs-6 col-sm-6">
            <img height=55 src="images/arcos.svg">
        </div>
        <div class="col-xs-6 col-sm-6">
            <center><a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">OK</a></center>
        </div>
        </div>
        </div>

   </div>

</div><!-- /popup -->


<div data-role="popup" id="help1" 
     data-theme="a" data-dismissible="false" data-animate="false" data-overlay-theme="b">

      <div data-role="header" data-theme="b" class="ui-corner-top">
           <div data-type="horizontal" data-role="controlgroup" class="ui-btn-left">  
             <div id="help1_ref" style="display:none;"></div>
	     <input name="radio6" id="radio6-es" data-mini="true"
		    style="margin-top:-8px"
		    onclick="set_cfg('ws_idiom','es'); save_cfg(); show_help1();"
		    value="ES" type="radio">
	     <label for="radio6-es">ES</label>
	     <input name="radio6" id="radio6-en" data-mini="true"
		    style="margin-top:-8px"
		    onclick="set_cfg('ws_idiom','en'); save_cfg(); show_help1();"
		    value="EN" type="radio">
	     <label for="radio6-en">EN</label>
           </div>
           <h1>Help</h1>
           <a href="#" 
              data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" 
              class="ui-btn-right">Close</a>
      </div>

      <div data-role="content" data-theme="d" class="ui-corner-bottom ui-content">
              <div class="ui-body-d ui-content" style="padding: 2px 2px 2px 2px;">
                 <div id=iframe_help1 style="height:80vh; width: 80vw; overflow-y: auto;"></div>
              </div>
      </div>

</div><!-- /panel -->


<div data-role="popup" id="bin1" 
     data-theme="a" data-dismissible="true" data-animate="false" data-overlay-theme="a">

      <div data-role="header" data-theme="b" class="ui-corner-top">
           <h1>Binary</h1>
           <a href="#" 
              data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" 
              class="ui-btn-right">Close</a>
      </div>

      <div data-role="content" data-theme="d" class="ui-corner-bottom ui-content">
              <div class="ui-body-d ui-content" style="padding: 2px 2px 2px 2px;">
                 <div id=iframe_bin1 style="height:80vh; width: 80vw; overflow-y: auto;">
		   <div id="compile_results">
                        <br>
                        <center>
                        Loading binary, please wait... <br>
                        WARNING: loading binary might take time on slow mobile devices.
                        </center>
                   </div>
                 </div>
              </div>
      </div>

</div><!-- /panel -->


<script>
    try 
    {
	    restore_cfg();

	    $(document).ready(function()
	    {
		    jQuery.fx.off = true;

		    $("#about1").enhanceWithin().popup();
		    $("#help1").enhanceWithin().popup().draggable().resizable();
		    $("#bin1").enhanceWithin().popup();

		    $("#actions_panel").panel().enhanceWithin();
		    $(".ui-slider-input").hide();
		    $("#listview_1").listview();

		    $("#tabsnav1").navbar();
		    $("#tabsnav2").navbar();
		    $("#tabsnav4").navbar();

		    $("#tabs1").tabs();
		    $("#tabs2").tabs();
		    $("#tabs3").tabs();
		    $("#tabs4").tabs();

		    inputfirm  = CodeMirror.fromTextArea(document.getElementById("inputFirmware"), {
								value: "",
								lineNumbers: true,
								matchBrackets: true,
								mode: "text/x-csrc"
						         });
                    inputfirm.setValue("\n\n\n\n\n\n\n\n\n");

		    inputasm   = CodeMirror.fromTextArea(document.getElementById("inputAssembly"), {
								value: "",
								lineNumbers: true,
								matchBrackets: true,
								extraKeys: {
								  "Ctrl-Space": function(cm) {
								      CodeMirror.showHint(cm, function(cm, options) {
										      var simware = get_simware();
										      var cur = cm.getCursor();
										      var result = new Array();
										      for (var i=0; i<simware.firmware.length; i++)
											   if(simware.firmware[i].name != "begin")
											   	result.push(simware.firmware[i].signatureUser); // TODO: signature user
										      return { list: result, from: cur, to: cur };
										    });
								  }
								},
								mode: "text/x-csrc"
						         });
                    inputasm.setValue("\n\n\n\n\n\n\n\n\n");

		    var a = document.getElementById("svg_p");
		    a.addEventListener("load",function() {
			sim_init();
			init_eventlistener("svg_p");
			refresh();
		    }, false);

		    var a = document.getElementById("svg_cu");
		    a.addEventListener("load",function() {
			sim_init();
			init_eventlistener("svg_cu");
			refresh();
		    }, false);

		    $.mobile.pageContainer.pagecontainer('change','#main1');
		    $('#tab11').trigger('click');
		    $('#tab22').trigger('click');

		    $("#colorpicker1").spectrum({ preferredFormat: "hex", color: get_cfg('color_data_active')}) ;
		    $("#colorpicker2").spectrum({ preferredFormat: "hex", color: get_cfg('color_name_active')}) ;
		    $("#radio1-" +         get_cfg('DBG_level')).prop('checked', true).checkboxradio("refresh") ;
		    $("#radio2-" + get_cfg('RF_display_format')).prop('checked', true).checkboxradio("refresh") ;
		    $("#radio3-" +   get_cfg('RF_display_name')).prop('checked', true).checkboxradio("refresh") ;
		    $("#radio5-" +    get_cfg('is_interactive')).prop('checked', true).checkboxradio("refresh") ;
		    $("#radio6-" +          get_cfg('ws_idiom')).prop('checked', true).checkboxradio("refresh") ;
	    }) ;

            $("div.wsversion").replaceWith(get_cfg('version'));

	    init(); 
	    reset(); 
    }
    catch(err) 
    {
        alert("WepSIM was improperly used:\n" + err.message);
    }
</script>

</body>

</html>

