var WSCFG=new Object();WSCFG.version={value:"1.5.2",type:"string"};function get_cfg(a){return WSCFG[a].value}function set_cfg(b,a){WSCFG[b].value=a}function reset_cfg(){WSCFG.color_data_active={value:"#0066FF",type:"string"};WSCFG.color_data_inactive={value:"rgb(0, 0, 0)",type:"string"};WSCFG.color_name_active={value:"red",type:"string"};WSCFG.color_name_inactive={value:"rgb(0, 0, 0)",type:"string"};WSCFG.size_active={value:1.22,type:"float"};WSCFG.size_inactive={value:0.02,type:"float"};WSCFG.DBG_delay={value:10,type:"int"};WSCFG.DBG_level={value:"instruction",type:"string"};WSCFG.RF_display_format={value:16,type:"int"};WSCFG.RF_display_name={value:"numerical",type:"string"};WSCFG.NOTIF_delay={value:500,type:"int"};WSCFG.is_interactive={value:true,type:"boolean"};WSCFG.is_byvalue={value:false,type:"boolean"};WSCFG.is_editable={value:false,type:"boolean"};WSCFG.ws_idiom={value:"es",type:"string"}}function save_cfg(){try{for(var b in WSCFG){localStorage.setItem("wepsim_"+b,get_cfg(b))}}catch(a){console.log("WepSIM can not save the configuration in a persistent way on this web browser, found error: \n"+a.message)}}function restore_cfg(){reset_cfg();for(var b in WSCFG){if(b=="version"){continue}try{set_cfg(b,localStorage.getItem("wepsim_"+b));if(WSCFG[b].type!="string"){set_cfg(b,JSON.parse(get_cfg(b)))}if(get_cfg(b)==null){throw"null values discarted"}}catch(a){console.log("WepSIM can not restore the configuration on this web browser, found error: \n"+a.message);reset_cfg();return}}}function get_simware(){if(typeof FIRMWARE.firmware=="undefined"){FIRMWARE.firmware=new Array();FIRMWARE.mp=new Object();FIRMWARE.seg=new Object();FIRMWARE.assembly=new Object();FIRMWARE.labels=new Object();FIRMWARE.labels2=new Object();FIRMWARE.registers=new Object();FIRMWARE.cihash=new Object();FIRMWARE.pseudoInstructions=new Object();FIRMWARE.stackRegister=new Object()}return FIRMWARE}function set_simware(a){if(typeof a.firmware!="undefined"){FIRMWARE.firmware=a.firmware}if(typeof a.mp!="undefined"){FIRMWARE.mp=a.mp}if(typeof a.registers!="undefined"){FIRMWARE.registers=a.registers}if(typeof a.cihash!="undefined"){FIRMWARE.cihash=a.cihash}if(typeof a.assembly!="undefined"){FIRMWARE.assembly=a.assembly}if(typeof a.pseudoInstructions!="undefined"){FIRMWARE.pseudoInstructions=a.pseudoInstructions}if(typeof a.seg!="undefined"){FIRMWARE.seg=a.seg}if(typeof a.labels!="undefined"){FIRMWARE.labels=a.labels}if(typeof a.labels2!="undefined"){FIRMWARE.labels2=a.labels2}if(typeof a.stackRegister!="undefined"){FIRMWARE.stackRegister=a.stackRegister}}function obj_draw(a,g,k,e,f,d){var b=a.split(":");var h=document.getElementById(b[0]);if(h==null){return}h=h.contentDocument;if(h==null){return}h=h.getElementById(b[1]);if(h==null){return}if(g){h.style.setProperty("stroke",k,"");h.style.setProperty("fill",k,"");h.style.setProperty("stroke-width",f,"")}else{if(h.style.getPropertyValue("stroke")==e){return}h.style.setProperty("stroke",e,"");h.style.setProperty("fill",e,"");h.style.setProperty("stroke-width",d,"")}}var DRAW_stop=false;function start_drawing(){DRAW_stop=false}function stop_drawing(){DRAW_stop=true}function update_draw(f,e){if(true==DRAW_stop){return}var g=get_cfg("is_byvalue");if(typeof sim_states.REG_MICROINS.value[f.name]!="undefined"){g=true}if((false==g)&&(typeof f.depends_on!="undefined")){for(var a=0;a<f.depends_on.length;a++){if(typeof sim_states.REG_MICROINS.value[f.depends_on[a]]!="undefined"){g=true;break}}}if(f.draw_data.length>1){for(var d=0;d<f.draw_data.length;d++){for(var b=0;b<f.draw_data[d].length;b++){obj_draw(f.draw_data[d][b],(d==e)&&g,get_cfg("color_data_active"),get_cfg("color_data_inactive"),get_cfg("size_active"),get_cfg("size_inactive"))}}for(var d=0;d<f.draw_name.length;d++){for(var b=0;b<f.draw_name[d].length;b++){obj_draw(f.draw_name[d][b],(d==e)&&g,get_cfg("color_name_active"),get_cfg("color_name_inactive"),get_cfg("size_active"),get_cfg("size_inactive"))}}}else{if(f.nbits==1){for(var b=0;b<f.draw_data[0].length;b++){obj_draw(f.draw_data[0][b],(0!=e)&&g,get_cfg("color_data_active"),get_cfg("color_data_inactive"),get_cfg("size_active"),get_cfg("size_inactive"))}for(var b=0;b<f.draw_name[0].length;b++){obj_draw(f.draw_name[0][b],(0!=e)&&g,get_cfg("color_name_active"),get_cfg("color_name_inactive"),get_cfg("size_active"),get_cfg("size_inactive"))}}else{if(f.draw_data.length==1){for(var b=0;b<f.draw_data[0].length;b++){obj_draw(f.draw_data[0][b],g,get_cfg("color_data_active"),get_cfg("color_data_inactive"),get_cfg("size_active"),get_cfg("size_inactive"))}for(var b=0;b<f.draw_name[0].length;b++){obj_draw(f.draw_name[0][b],g,get_cfg("color_name_active"),get_cfg("color_name_inactive"),get_cfg("size_active"),get_cfg("size_inactive"))}}}}}function refresh(){for(var a in sim_signals){update_draw(sim_signals[a],sim_signals[a].value)}show_dbg_ir(get_value(sim_states.REG_IR_DECO))}function init_rf(e){if(e==""){return}if(get_cfg("is_editable")==true){for(var d=0;d<sim_states.BR.length;d++){sim_states.BR[d].value=ko.observable(sim_states.BR[d].default_value)}}var a="";for(var d=0;d<sim_states.BR.length;d++){if(get_cfg("is_editable")==true){a+="<div class='col-xs-2 col-sm-1 col-md-2 col-lg-1' id='name_RF"+d+"' style='padding: 0 15 0 5;'>R"+d+"</div><div class='col-xs-4 col-sm-2 col-md-4 col-lg-3' id='tbl_RF"+d+"' style='padding: 0 5 0 35;'><input size=10 data-role=none data-bind='value:value'></div>"}else{a+="<div class='col-xs-2 col-sm-1 col-md-2 col-lg-1' id='name_RF"+d+"' style='padding: 0 15 0 5;'>R"+d+"</div><div class='col-xs-4 col-sm-2 col-md-4 col-lg-3' id='tbl_RF"+d+"' style='padding: 0 5 0 35;'>"+(get_value(sim_states.BR[d])>>>0).toString(get_cfg("RF_display_format")).toUpperCase()+"</div>"}}$(e).html("<div class='row-fluid'>"+a+"</div>");if(get_cfg("is_editable")==true){for(var d=0;d<sim_states.BR.length;d++){var b=document.getElementById("tbl_RF"+d);ko.applyBindings(sim_states.BR[d],b)}}}function show_rf_values(){if(get_cfg("is_editable")==true){return}var b=get_simware();for(var d=0;d<sim_states.BR.length;d++){var a=(get_value(sim_states.BR[d])>>>0).toString(get_cfg("RF_display_format")).toUpperCase();if(16==get_cfg("RF_display_format")){a="00000000".substring(0,8-a.length)+a}var e=document.getElementById("tbl_RF"+d);if(e!=null){e.innerHTML=a}}}function show_rf_names(){var b=get_simware();for(var d=0;d<sim_states.BR.length;d++){var a="R"+d;if("logical"==get_cfg("RF_display_name")){if(typeof b.registers[d]!="undefined"){a=b.registers[d]}}var e=document.getElementById("name_RF"+d);if(e!=null){e.innerHTML=a}}}function init_eltos(g,o,d,k){if(g==""){return}if(get_cfg("is_editable")==true){for(var h=0;h<d.length;h++){var p=d[h].split(",")[0];o[p].value=ko.observable(o[p].default_value)}}var e="";for(var h=0;h<d.length;h++){var p=d[h].split(",")[0];var f=o[p].name;if(f.length>7){f=f.substring(0,7)+"..."}var n=d[h].split(",")[1];var m=k[n];if(get_cfg("is_editable")==true){e+="<div class='"+m+"' style='padding: 0 5 0 5;'>"+f+"</div><div class='"+m+"' id='tbl_"+p+"' style='padding: 0 5 0 0;'><input size=10 data-role=none data-bind='value:value'></div>"}else{e+="<div class='"+m+"' style='padding: 0 5 0 5;'>"+f+"</div><div class='"+m+"' id='tbl_"+p+"' style='padding: 0 5 0 0;'>"+o[p].value.toString(get_cfg("RF_display_format"))+"</div>"}}$(g).html("<div class='row-fluid'>"+e+"</div>");if(get_cfg("is_editable")==true){for(var h=0;h<d.length;h++){var p=d[h].split(",")[0];var a=document.getElementById("tbl_"+p);ko.applyBindings(o[p],a)}}}function show_eltos(h,d){if(get_cfg("is_editable")==true){return}for(var b=0;b<d.length;b++){var e=d[b].split(",");var a=e[0];var f=h[a].value.toString(get_cfg("RF_display_format"));if(h[a].nbits>1){f=(sim_states[a].value>>>0).toString(get_cfg("RF_display_format")).toUpperCase();if(16==get_cfg("RF_display_format")){f="<font color=gray>"+"00000000".substring(0,8-f.length)+"</font>"+f}}var g=document.getElementById("tbl_"+a);if(g!=null){g.innerHTML=f}}}var filter_states=["REG_IR_DECO,1","REG_IR,0","REG_PC,0","REG_SR,0","REG_RT1,0","REG_RT2,0","REG_RT3,0","REG_MAR,0","REG_MBR,0","REG_MICROADDR,0","FLAG_C,0","FLAG_V,0","FLAG_N,0","FLAG_Z,0","FLAG_I,0","FLAG_U,0"];var divclasses=["col-xs-3 col-sm-3 col-md-3 col-lg-2","col-xs-6 col-sm-6 col-md-6 col-lg-6"];function init_states(a){return init_eltos(a,sim_states,filter_states,divclasses)}function show_states(){return show_eltos(sim_states,filter_states)}function init_io(e){if(e==""){sim_states.CLK.value=ko.observable(sim_states.CLK.value);sim_states.DECO_INS.value=ko.observable(sim_states.DECO_INS.value);for(var b=0;b<IO_INT_FACTORY.length;b++){IO_INT_FACTORY[b].accumulated=ko.observable(IO_INT_FACTORY[b].accumulated)}return}var d="<center>";d+="<div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>Instructions</div><div class='col-xs-6 col-sm-6 col-md-6 col-lg-6' id='ins_context'><span data-bind='text: value'>&nbsp;</span></div>";d+="<div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>CLK ticks</div><div class='col-xs-6 col-sm-6 col-md-6 col-lg-6' id='clk_context'><span data-bind='text: value'>&nbsp;</span></div>";d+="<div class='col-xs-12 col-sm-12 col-md-12 col-lg-12'>&nbsp;</div>";for(var b=0;b<IO_INT_FACTORY.length;b++){d+="<div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>Interrupt "+b+"</div><div class='col-xs-6 col-sm-6 col-md-6 col-lg-6' id='int"+b+"_context'><span data-bind='text: accumulated'>&nbsp;</span></div>"}d+="</center>";$(e).html("<div class='row-fluid'>"+d+"</div>");sim_states.CLK.value=ko.observable(sim_states.CLK.value);var a=document.getElementById("clk_context");ko.applyBindings(sim_states.CLK,a);sim_states.DECO_INS.value=ko.observable(sim_states.DECO_INS.value);var a=document.getElementById("ins_context");ko.applyBindings(sim_states.DECO_INS,a);for(var b=0;b<IO_INT_FACTORY.length;b++){IO_INT_FACTORY[b].accumulated=ko.observable(IO_INT_FACTORY[b].accumulated);var a=document.getElementById("int"+b+"_context");ko.applyBindings(IO_INT_FACTORY[b],a)}}function init_config(e){if(e==""){for(var b=0;b<IO_INT_FACTORY.length;b++){IO_INT_FACTORY[b].period=ko.observable(IO_INT_FACTORY[b].period);IO_INT_FACTORY[b].probability=ko.observable(IO_INT_FACTORY[b].probability)}MP_wc=ko.observable(MP_wc);return}var d="<div class='panel panel-default'><div class='panel-heading'>  <h3 class='panel-title'>I/O</h3></div><div class='panel-body'>  <div class='row-fluid'>  <center>";for(var b=0;b<8;b++){if(0==b){d+="<div class='col-xs-4 col-sm-4 col-md-4 col-lg-4'>Interrupt Id.</div><div class='col-xs-4 col-sm-4 col-md-4 col-lg-4'>CLK tick period</div><div class='col-xs-4 col-sm-4 col-md-4 col-lg-4'>Probability (0.0-1.0)</div>"}d+="<div class='col-xs-4 col-sm-4 col-md-4 col-lg-4' style='padding: 15 5 0 10;'>"+b+"</div><div class='col-xs-4 col-sm-4 col-md-4 col-lg-4' style='padding: 0 5 0 10;' id='int"+b+"_per'><input type=number data-bind='value: period' min='0'></div><div class='col-xs-4 col-sm-4 col-md-4 col-lg-4' style='padding: 0 5 0 10;' id='int"+b+"_pro'><input type=number data-bind='value: probability' min='0' max='1' step='.1'></div>"}d+="  </center>  </div></div></div>";d+="<div class='panel panel-default'><div class='panel-heading'>  <h3 class='panel-title'>Memory</h3></div><div class='panel-body'>  <div class='row-fluid'>  <center>  <div class='col-xs-6 col-sm-6 col-md-6 col-lg-6' style='padding: 15 5 0 10;'>Memory wait cycles</div>  <div class='col-xs-6 col-sm-6 col-md-6 col-lg-6' id='mp_wc'><input type=number data-bind='value: MP_wc' min=1></div>  </center>  </div></div></div>";$(e).html(d);for(var b=0;b<IO_INT_FACTORY.length;b++){IO_INT_FACTORY[b].period=ko.observable(IO_INT_FACTORY[b].period);var a=document.getElementById("int"+b+"_per");ko.applyBindings(IO_INT_FACTORY[b],a);IO_INT_FACTORY[b].probability=ko.observable(IO_INT_FACTORY[b].probability);var a=document.getElementById("int"+b+"_pro");ko.applyBindings(IO_INT_FACTORY[b],a)}MP_wc=ko.observable(MP_wc);var a=document.getElementById("mp_wc");ko.applyBindings(MP_wc,a)}function show_memories(b,h,a){var f="";var e="";for(var d in h){if(typeof h[d]=="object"){e="";for(var g in h[d]){if(1==h[d][g]){e+=g+" ";continue}e+=g+"="+parseInt(h[d][g]).toString(2)+" "}if(d==a){f+="<tr><td width=15%>0x"+parseInt(d).toString(16)+"</td><td><b><div style='color: blue'>"+e+"</div></b></td></tr>"}else{f+="<tr><td width=15%><small>0x"+parseInt(d).toString(16)+"</small></td><td          ><div><small>"+e+"</small></div></td></tr>"}}else{e=h[d].toString(16);e="00000000".substring(0,8-e.length)+e;value2=e[0]+e[1]+" "+e[2]+e[3]+" "+e[4]+e[5]+" "+e[6]+e[7];key2=parseInt(d).toString(16);key3=(parseInt(d)+3).toString(16);for(skey in segments){if(parseInt(segments[skey].begin)==parseInt(d)){f+="</tbody><tbody id=begin_"+skey+">"}}if(d==a){f+="<tr><td width=50%><font color=blue><b>0x"+key3+"-"+key2+"</b></font></td><td          ><font color=blue><b>"+value2+"</b></font></td></tr>"}else{f+="<tr><td width=50%><small>0x"+key3+"-"+key2+"</small></td><td          ><small>"+value2+"</small></td></tr>"}}}if(typeof h[a]=="undefined"){f+="<tr><td width=15%><font color=blue>0x"+parseInt(a).toString(16)+"</font></td><td><font color=blue><b>&nbsp;</b></font></td></tr>"}$("#memory_"+b).html("<center><table class='table table-hover table-condensed table-responsive'><tbody id=none>"+f+"</tbody></table></center>")}function show_asmdbg_pc(){var a=get_simware();var d=null;for(l in a.assembly){d=$("#asmdbg"+l);d.css("background-color",a.assembly[l].bgcolor)}var b=get_value(sim_states.REG_PC);var e="0x"+b.toString(16);d=$("#asmdbg"+e);d.css("background-color","#00EE88")}function show_dbg_mpc(){show_memories("MC",MC,get_value(sim_states.REG_MICROADDR))}function show_dbg_ir(a){var b=document.getElementById("svg_p");if(b!=null){b=b.contentDocument}if(b!=null){b=b.getElementById("tspan3899")}if(b!=null){b.innerHTML=a}var b=document.getElementById("svg_cu");if(b!=null){b=b.contentDocument}if(b!=null){b=b.getElementById("text3611")}if(b!=null){b.innerHTML=a}}function firmware2html(z,B){var n=["A0,0","B,0","C,0","SELA,5","SELB,5","SELC,2","SELCOP,0","MR,0","MC,0","C0,0","C1,0","C2,0","C3,0","C4,0","C5,0","C6,0","C7,0","T1,0","T2,0","T3,0","T4,0","T5,0","T6,0","T7,0","T8,0","T9,0","T10,0","T11,0","M1,0","M2,0","M7,0","MA,0","MB,0","SELP,0","LC,0","SE,0","SIZE,0","OFFSET,0","BW,0","R,0","W,0","TA,0","TD,0","IOR,0","IOW,0","I,0","U,0"];var D="<tr bgcolor=#FF9900><td bgcolor=white     style='border-style: solid; border-width:0px; border-color:lightgray;'></td><td bgcolor=lightblue style='border-style: solid; border-width:1px; border-color:lightgray;'>co</td><td bgcolor=#FFCC00   style='border-style: solid; border-width:1px; border-color:lightgray;' align=center><small><b>&#181;dir</b></small></td><td bgcolor=white     style='border-style: solid; border-width:0px; border-color:lightgray;'>&nbsp;&nbsp;</td>";var A=1;for(var C=0;C<n.length;C++){var q=n[C].split(",")[0];D+="<td align=center style='border-style: solid; border-width:1px;'><small><b>"+sim_signals[q].name+"</b></small></td>";A++}D+="</tr>";var w="<center>";w+="<table style='table-layout:auto; border-style: solid: border-width:0px; border-collapse:collapse;'>";var x=0;var m="";var g="";var F="";for(var C=0;C<z.length;C++){var v=z[C]["mc-start"];var e=z[C].microcode;for(j=0;j<e.length;j++){if(++x%10==1){w=w+D}g="";if(typeof z[C].co!="undefined"){g=parseInt(z[C].co,2)}var t=z[C].signature.split(",")[0];m="";if(j==0){m+="<td style='border-style: solid; border-width:0px; border-color:lightgray;'><span class='badge'>"+t+"</span>&nbsp;</td><td style='border-style: solid; border-width:1px; border-color:lightgray;'>"+g+"</td>"}else{m+="<td style='border-style: solid; border-width:0px; border-color:lightgray;'>&nbsp;</td><td style='border-style: solid; border-width:1px; border-color:lightgray;'>&nbsp;</td>"}if(B){F="0x"+(v+j).toString(16)}else{F=v+j}m+="<td align=center  style='border-style: solid; border-width:1px; border-color:lightgray;' bgcolor=white>"+F+"</td><td bgcolor=white style='border-style: solid; border-width:0px; border-color:lightgray;'>&nbsp;</td>";var f=e[j];for(var y=0;y<n.length;y++){var q=n[y].split(",")[0];var E=parseInt(sim_signals[q].default_value);var p=false;if((typeof f[q]!="undefined")&&(!isNaN(parseInt(f[q])))){E=parseInt(f[q]);p=true}if((q=="SELA"||q=="SELB"||q=="SELC")&&(typeof f.MADDR!="undefined")&&(!isNaN(parseInt(f.MADDR)))){var b=parseInt(f.MADDR).toString(2);b="000000000000".substring(0,12-b.length)+b+"000";if(q=="SELA"){E=parseInt(b.substring(0,5),2);p=true}if(q=="SELB"){E=parseInt(b.substring(5,10),2);p=true}if(q=="SELC"){E=parseInt(b.substring(10,15),2);p=true}}if(B){var b=E.toString(2);var u=parseInt(sim_signals[q].nbits);E="00000000000000000000000000000000".substring(0,u-b.length)+b;var G=n[y].split(",")[1];var d=E.substring(0,G);var a=E.substring(G);E="<font color=green>"+d+"</font>"+a}if(p){m+="<td align=center style='border-style: solid; border-width:1px;'><b>"+E+"</b></td>"}else{m+="<td align=center style='border-style: solid; border-width:1px;'><font color='grey'>"+E+"</font></td>"}}w+="<tr>"+m+"</tr>"}}w+="</table></center>";return w}function labels2html_aux(a,e){var d="";var b="";b="0x"+(parseInt(e)+3).toString(16);if(typeof a[b]!="undefined"){d=d+"<span class='badge'>"+a[b]+"</span>"}else{d=d+"&nbsp;"}b="0x"+(parseInt(e)+2).toString(16);if(typeof a[b]!="undefined"){d=d+"<span class='badge'>"+a[b]+"</span>"}else{d=d+"&nbsp;"}b="0x"+(parseInt(e)+1).toString(16);if(typeof a[b]!="undefined"){d=d+"<span class='badge'>"+a[b]+"</span>"}else{d=d+"&nbsp;"}b="0x"+(parseInt(e)+0).toString(16);if(typeof a[b]!="undefined"){d=d+"<span class='badge'>"+a[b]+"</span>"}else{d=d+"&nbsp;"}return d}function mp2html(g,k,b){var e=new Object();for(l in k){e[k[l]]=l}var h="";h+="<center><table style='table-layout:auto; border-style: solid; border-width:0px;'><tr><th style='border-style: solid; border-width:0px;'>labels</th><th style='border-style: solid; border-width:1px;'>address</th><th style='border-style: solid; border-width:1px;'><table border=0 width=100%><tr align=center>  <td width=25% align=center><small><b>byte 3</b></small></td>  <td width=25% align=center><small><b>byte 2</b></small></td>  <td width=25% align=center><small><b>byte 1</b></small></td>  <td width=25% align=center><small><b>byte 0</b></small></td></tr><tr>  <td width=12% align=center >&nbsp;<sup>31&nbsp;&nbsp;......&nbsp;&nbsp;24</sup>&nbsp;</td>  <td width=12% align=center >&nbsp;<sup>23&nbsp;&nbsp;......&nbsp;&nbsp;16</sup>&nbsp;</td>  <td width=12% align=center >&nbsp;<sup>15&nbsp;&nbsp;......&nbsp;&nbsp;8</sup>&nbsp;</td>  <td width=12% align=center >&nbsp;<sup>7&nbsp;&nbsp;......&nbsp;&nbsp;0</sup>&nbsp;</td></tr></table><th style='border-style: solid; border-width:0px;' align=right>&nbsp;&nbsp;segment</th></tr>";var d="white";for(skey in b){c_begin=parseInt(b[skey].begin);c_end=parseInt(b[skey].end);d=b[skey].color;rows=0;var a="";for(var f=c_begin;f<c_end;f++){c="0x"+f.toString(16);if(typeof g[c]=="undefined"){continue}if(0==rows){h+="<tr style='font-family:'Consolas'; font-size:11pt;'><td align=right  style='border-style: solid; border-width:0px;'>"+labels2html_aux(e,c)+"</td><td              style='border-style: solid; border-width:1px;' bgcolor="+d+">"+c.toUpperCase()+"</td><td              style='border-style: solid; border-width:1px;' bgcolor="+d+">"+g[c].substr(0,8)+"&nbsp;"+g[c].substr(8,8)+"&nbsp;"+g[c].substr(16,8)+"&nbsp;"+g[c].substr(24,8)+"</td><td rowspan="}else{a+="<tr style='font-family:'Consolas'; font-size:11pt;'><td align=right  style='border-style: solid; border-width:0px;'>"+labels2html_aux(e,c)+"</td><td              style='border-style: solid; border-width:1px;' bgcolor="+d+">"+c.toUpperCase()+"</td><td              style='border-style: solid; border-width:1px;' bgcolor="+d+">"+g[c].substr(0,8)+"&nbsp;"+g[c].substr(8,8)+"&nbsp;"+g[c].substr(16,8)+"&nbsp;"+g[c].substr(24,8)+"</td></tr>"}rows++}if(0==rows){h+="<tr style='font-family:'Consolas'; font-size:12pt;'><td>&nbsp;</td><td style='border-style: solid; border-width:1px;' bgcolor="+d+">0x"+parseInt(b[skey].begin).toString(16).toUpperCase()+"</td><td style='border-style: solid; border-width:1px;' bgcolor="+d+">&nbsp;</td><td rowspan=";a+="<tr style='font-family:'Consolas'; font-size:12pt;'><td>&nbsp;</td><td style='border-style: solid; border-width:1px;' bgcolor="+d+">0x"+parseInt(b[skey].end).toString(16).toUpperCase()+"</td><td style='border-style: solid; border-width:1px;' bgcolor="+d+">&nbsp;</td><td>&nbsp;</td></tr>";rows=2}h+=rows+" align=right>"+b[skey].name+"&nbsp;</td></tr>"+a;if(b[skey].name!="stack"){h+="<tr style='font-family:'Consolas'; font-size:12pt;'><td>&nbsp;</td><td valign=middle align=center height=25px>...</td><td valign=middle align=center height=25px>...</td><td>&nbsp;</td></tr>"}}h+="</table></center><br>";return h}function segments2html(a){var b="<br>";b+=" <center> <table height=400px> <tr> <td><table style='border-style: solid' border=1 width=100% height=100%>";for(skey in a){if(a[skey].name!="stack"){b+="<tr><td valign=middle align=center bgcolor="+a[skey].color+">"+a[skey].name+"</td></tr><tr><td valign=middle align=center height=25px>...</td></tr>"}}b+="<tr><td valign=middle align=center bgcolor="+a.stack.color+">"+a.stack.name+"</td></tr></table> </td> <td width=20px>&nbsp;</td> <td> <table style='border-style: solid; border-width:0px; width:100%; height:100%'>";var d=0;for(skey in a){d+=1;if(a[skey].name!="stack"){b+="<tr>    <td valign=middle align=center style='display: block; position: absolute;'>    <div id='compile_begin_"+a[skey].name+"'          style='position:relative; bottom:"+(3*d)+"px;'>"+a[skey].begin+"</div>    </td> </tr> <tr>    <td valign=middle align=center style='display: block; position: absolute;'>    <div id='compile_end_"+a[skey].name+"'          style='position:relative; bottom:"+(2*d)+"px;'>"+a[skey].end+"</div>    </td> </tr>"}}b+="  <tr>  <td valign=middle align=center style='display: block; position: absolute;'><div id='compile_end_"+a.stack.name+"' style='position:relative;bottom:25px;'>[SP_n]</div><div id='compile_begin_"+a.stack.name+"' style='position:relative;bottom:-20px;'>[SP_0]</div>  </td>  </tr> </table> </td> </tr> </table> </center>";return b}function assembly2html(d,h,f,e){var m="";var n="";var g="";var k="";var b="#F0F0F0";var a="";a+="<center><table data-role=table class='table ui-responsive'><tbody>";for(l in e){if(b=="#F0F0F0"){b="#F8F8F8"}else{b="#F0F0F0"}e[l].bgcolor=b;r=e[l].source.split(":");if(r.length>1){m=r[0]+":";n=r[1]}else{m="&nbsp;";n=r[0]}r=e[l].source_original.split(":");if(r.length>1){g=r[0]+":";k=r[1]}else{g="&nbsp;";k=r[0]}a+="<tr id='asmdbg"+l+"' bgcolor='"+e[l].bgcolor+"'><td                   style='line-height:0.9;' width='10%' id='bp"+l+"'                       onclick='asmdbg_set_breakpoint("+l+"); if(event.stopPropagation) event.stopPropagation();'>&nbsp;</td><td                   style='line-height:0.9;' width='15%'>"+l+"</td><td                   style='line-height:0.9;' width='10%' align=right>"+m+"</td><td                   style='line-height:0.9;' width='29%' align=left>"+n+"</td><td class='hidden-xs' style='line-height:0.9;' width='10%' align=right>"+g+"</td><td class='hidden-xs' style='line-height:0.9;' width='25%' align=left>"+k+"</td></tr>"}a+="</tbody></table></center>";return a}var DBG_stop=true;function asmdbg_set_breakpoint(f){var a=get_simware();var b="0x"+f.toString(16);var e=document.getElementById("bp"+b);var d=a.assembly[b].breakpoint;if(d===true){d=false;e.innerHTML="&nbsp;"}else{d=true;e.innerHTML='<img height=22 src="images/stop.png">'}a.assembly[b].breakpoint=d}function asmdbg_stop(a){$(a).html("Run");$(a).removeClass("ui-icon-minus");$(a).addClass("ui-icon-carat-r");$(a).css("backgroundColor","#CCCCCC");DBG_stop=true}function asmdbg_play(d){$(d).css("backgroundColor","rgb(51, 136, 204)");$(d).html("Stop");$(d).removeClass("ui-icon-carat-r");$(d).addClass("ui-icon-minus");if(DBG_stop){asmdbg_stop(d);return}var b=false;if(get_cfg("DBG_level")=="instruction"){b=execute_instruction()}else{b=execute_microinstruction()}if(b===false){asmdbg_stop(d);return}var a=get_simware();reg_pc=get_value(sim_states.REG_PC);curr_addr="0x"+reg_pc.toString(16);if((typeof a.assembly[curr_addr]!="undefined")&&(a.assembly[curr_addr].breakpoint)){asmdbg_stop(d);alert("Breakpoint @ "+curr_addr+":\nInstruction at "+curr_addr+" is going to be fetched.");return}setTimeout(asmdbg_play,get_cfg("DBG_delay"),d)}function check_ib(g){$("#databus_fire").hide();if((sim_signals.TD.value!=0)&&(sim_signals.R.value!=0)){$("#databus_fire").show();sim_states.BUS_DB.value=4294967295}var a="";var e=["T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11"];if(e.indexOf(g)==-1){return}var d=0;var f="";for(var b=0;b<e.length;b++){a=e[b];if(sim_signals[a].value!=0){d++;f=a}if(d>1){break}}if(d>0){update_draw(sim_signals[f],1)}$("#internalbus_fire").hide();if(d>1){$("#internalbus_fire").show();sim_states.BUS_IB.value=4294967295}}function check_behavior(){for(var f in sim_signals){for(var h in sim_signals[f].behavior){var a=sim_signals[f].behavior[h].split(";");for(var e=0;e<a.length;e++){var b=a[e].trim();var k=b.split(" ");if(""==b){continue}if(typeof(syntax_behavior[k[0]])=="undefined"){alert("ALERT: Unknown operation -> "+k[0]+" ("+b+")");return}if(k.length!=syntax_behavior[k[0]].nparameters){alert("ALERT: Behavior has an incorrect number of elements --> "+b+"/"+syntax_behavior[k[0]].nparameters);return}for(var d=1;d<k.length;d++){if("E"==syntax_behavior[k[0]].types[d-1]){var g=k[d].split("/");if(typeof(sim_states[g[0]])=="undefined"){alert("ALERT: Behavior has an undefined reference to a object state -> '"+b);return}}else{if("S"==syntax_behavior[k[0]].types[d-1]){var g=k[d].split("/");if(typeof(sim_signals[g[0]])=="undefined"){alert("ALERT: Behavior has an undefined reference to a signal -> '"+b);return}}}}}}}}function load_check(){if(0==sim_signals.length){alert("ALERT: empty signals!!!")}if(0==sim_states.length){alert("ALERT: empty states!!!")}check_behavior()}function compute_behavior(d){var e=d.split(";");for(var b=0;b<e.length;b++){e[b]=e[b].trim();if(""==e[b]){continue}var a=e[b].split(" ");syntax_behavior[a[0]].operation(a)}}function update_state(b){var a=0;var d="";switch(sim_signals[b].behavior.length){case 0:return;break;case 1:a=sim_signals[b].value;d=sim_signals[b].behavior[0];break;default:a=sim_signals[b].value;if(a<sim_signals[b].behavior.length){d=sim_signals[b].behavior[a]}else{alert("ALERT: there are more signals values than behaviors defined!!!!\nkey: "+b+" and signal value: "+a)}break}compute_behavior(d)}function get_value(a){if(typeof a.value=="function"){return a.value()}else{if(typeof a.default_value=="object"){return a.value}else{return a.value}}}function set_value(a,b){if(typeof a.value=="function"){a.value(b)}else{if(typeof a.default_value=="object"){a.value=b}else{a.value=b}}}function reset_value(b){if(typeof b.value=="function"){b.value(b.default_value)}else{if(typeof b.default_value=="object"){b.value=Object.create(b.default_value)}else{if(typeof b=="array"){for(var a=0;a<b.length;a++){b[a].value(b[a].default_value)}}else{b.value=b.default_value}}}}function show_memories_values(){show_memories("MP",MP,get_value(sim_states.REG_PC));show_memories("MC",MC,get_value(sim_states.REG_MICROADDR))}function update_signal_firmware(d){var a=get_simware();var g=-1;for(var b=0;b<a.firmware.length;b++){if(parseInt(a.firmware[b]["mc-start"])>get_value(sim_states.REG_MICROADDR)){break}g=b}if(-1==g){alert("A new 'unknown' instruction is inserted,\nplease edit it (co, nwords, etc.) in the firmware textarea.");var e=new Object();e.name="unknown";e.signature="unknown";e.signatureGlobal="unknown";e.co=0;e.nwords=0;e["mc-start"]=0;e.fields=new Array();e.microcode=new Array();a.firmware.push(e);g=a.firmware.length-1}var h=get_value(sim_states.REG_MICROADDR)-parseInt(a.firmware[g]["mc-start"]);if(typeof a.firmware[g]["microcode"][h]=="undefined"){a.firmware[g]["microcode"][h]=new Object()}a.firmware[g]["microcode"][h][d]=sim_signals[d].value;if(sim_signals[d].default_value==sim_signals[d].value){delete a.firmware[g]["microcode"][h][d]}var f=get_value(sim_states.REG_IR).toString(2);f="00000000000000000000000000000000".substring(0,32-f.length)+f;show_memories_values()}function update_signal_loadhelp(a,d){$(a).collapse("toggle");var b="help/signals-"+get_cfg("ws_idiom")+".html #"+d;$(a).load(b,function(f,e,g){if($(a).html()==""){$(a).html("<br>Sorry, No more details available for this signal.<p>\n")}$(a).trigger("create")})}function update_signal(b){if(false===get_cfg("is_interactive")){return}for(var m in sim_signals){for(var e=0;e<sim_signals[m].fire_name.length;e++){var a=sim_signals[m].fire_name[e].split(":");if(a[1]==b.currentTarget.id){var n=0;if(sim_signals[m].nbits==1){n=((sim_signals[m].value>>>0)+1)%2}var f="";var h="";var g=Math.pow(2,sim_signals[m].nbits);if(sim_signals[m].behavior.length==g){for(var d=0;d<sim_signals[m].behavior.length;d++){if(d==n){f=' checked="checked" '}else{f=" "}h+='<li><label><input type="radio" name="ask_svalue"  value="'+d.toString(10)+'" '+f+" />&nbsp;"+sim_signals[m].behavior[d].split(";")[0]+", ...</label></li>"}}else{h+='<div><label><input type="number" size=4 min=0 max='+(g-1)+' name="ask_svalue"        value="'+sim_signals[m].value+'"/>&nbsp;&nbsp; 0 - '+(g-1)+"</label></div>\n"}bootbox.dialog({title:"Decimal values for "+m+": ",message:'<div class="panel panel-default">  <div class="panel-heading"        style="background-color: #D4E017; -webkit-text-shadow: none; text-shadow: none; border-color: #D4E017; background-color: #D4E017; background-image: none;"       onclick=\'update_signal_loadhelp("#help2",$("#ask_skey").val());\'><b>Press here to search additional details or close details...</b>  </div>  <div id=help2 class="panel-collapse collapse" style="max-height:60vh; width: inherit; overflow-x: auto">Loading...</div></div><form class="form-horizontal"><input id="ask_skey"   name="ask_skey"   type="hidden" value="'+m+'" class="form-control input-md"> <ol start="0">'+h+"</ol></form>",value:sim_signals[m].value,animate:false,buttons:{close:{label:"Close",className:"btn-danger",callback:function(){}},success:{label:"Save",className:"btn-success",callback:function(){m=$("#ask_skey").val();user_input=$("input[name='ask_svalue']:checked").val();if(typeof user_input=="undefined"){user_input=$("input[name='ask_svalue']").val()}sim_signals[m].value=user_input;if(true===get_cfg("is_interactive")){sim_states.REG_MICROINS.value[m]=sim_signals[m].value;if(typeof MC[get_value(sim_states.REG_MICROADDR)]=="undefined"){MC[get_value(sim_states.REG_MICROADDR)]=new Object()}MC[get_value(sim_states.REG_MICROADDR)][m]=sim_signals[m].value;update_signal_firmware(m);var k=get_simware();document.getElementById("inputFirmware").value=saveFirmware(k)}compute_behavior("FIRE "+m)}}}})}}}show_states();show_rf_values()}function update_memories(q){set_simware(q);var h=get_simware();MC=new Object();for(var d=0;d<h.firmware.length;d++){var p=h.firmware[d]["microcode"].length;var k=h.firmware[d]["mc-start"];for(var b=0;b<p;b++){MC[k]=h.firmware[d]["microcode"][b];k++}}ROM=new Object();for(var d=0;d<h.firmware.length;d++){if("begin"==h.firmware[d]["name"]){continue}var o=h.firmware[d]["mc-start"];var m=parseInt(h.firmware[d]["co"],2);var a=0;if(typeof h.firmware[d]["cop"]!="undefined"){a=parseInt(h.firmware[d]["cop"],2)}var e=64*m+a;ROM[e]=o;h.cihash[e]=h.firmware[d]["signature"]}MP=new Object();for(var n in h.mp){var f=parseInt(n);var g=parseInt(h.mp[n].replace(/ /g,""),2);MP[f]=g}segments=new Object();for(var n in h.seg){segments[n]=h.seg[n]}show_memories("MP",MP,1);show_memories("MC",MC,1)}function init(){load_check();init_states("#states_ALL");init_rf("#states_BR");init_io("#io_ALL");init_config("#config_ALL")}function init_eventlistener(e){for(var d in sim_signals){for(var b=0;b<sim_signals[d].fire_name.length;b++){var f=sim_signals[d].fire_name[b].split(":");if(f[0]!=e){continue}var g=document.getElementById(f[0]).contentDocument;if(null==g){console.log('warning: unreferenced graphic element context named "'+f[0]+'".');continue}var a=g.getElementById(f[1]);if(null==a){console.log('warning: unreferenced graphic element named "'+f[0]+":"+f[1]+'".');continue}a.addEventListener("click",update_signal,false)}}}function reset(){var a=get_simware();compute_behavior("RESET");if((typeof segments[".ktext"]!="undefined")&&(a.labels2.kmain)){set_value(sim_states.REG_PC,parseInt(a.labels2.kmain));show_asmdbg_pc()}else{if((typeof segments[".text"]!="undefined")&&(a.labels2.main)){set_value(sim_states.REG_PC,parseInt(a.labels2.main));show_asmdbg_pc()}}if(typeof segments[".stack"]!="undefined"){set_value(sim_states.BR[FIRMWARE.stackRegister],parseInt(segments[".stack"].begin))}compute_behavior("CLOCK");show_dbg_ir(get_value(sim_states.REG_IR_DECO));show_states();show_rf_values();show_rf_names();show_memories("MP",MP,0);show_memories("MC",MC,0)}function execute_microinstruction(){if(false===get_cfg("is_interactive")){if((typeof segments[".ktext"]=="undefined")&&(typeof segments[".text"]=="undefined")){alert("code segment .ktext/.text does not exist!");return false}var a=parseInt(get_value(sim_states.REG_PC));if((parseInt(get_value(sim_states.REG_MICROADDR))==0)&&((a>=parseInt(segments[".ktext"].end))||(a<parseInt(segments[".ktext"].begin)))&&((a>=parseInt(segments[".text"].end))||(a<parseInt(segments[".text"].begin)))){alert("PC register points outside .ktext/.text code segments!");return false}}compute_behavior("CLOCK");show_states();show_rf_values();show_dbg_mpc()}function execute_microprogram(){do{compute_behavior("CLOCK")}while((0!=get_value(sim_states.REG_MICROADDR))&&(typeof MC[get_value(sim_states.REG_MICROADDR)]!="undefined"));show_states();show_rf_values();if(get_cfg("DBG_level")=="microinstruction"){show_dbg_mpc()}}function execute_instruction(){var a=get_simware();if((!((typeof segments[".ktext"]!="undefined")&&(a.labels2.kmain)))&&(!((typeof segments[".text"]!="undefined")&&(a.labels2.main)))){alert("labels 'kmain' (in .ktext) or 'main' (in .text) do not exist!");return false}if((typeof segments[".ktext"]=="undefined")&&(typeof segments[".text"]=="undefined")){alert("code segment .ktext/.text does not exist!");return false}var b=parseInt(get_value(sim_states.REG_PC));if((parseInt(get_value(sim_states.REG_MICROADDR))==0)&&((b>=parseInt(segments[".ktext"].end))||(b<parseInt(segments[".ktext"].begin)))&&((b>=parseInt(segments[".text"].end))||(b<parseInt(segments[".text"].begin)))){alert("PC register points outside .ktext/.text code segments!");return false}execute_microprogram();return true}function load_firmware(a){if(""==a.trim()){var d=new Object();d.error="Empty Firmware";return d}try{var d=JSON.parse(a);update_memories(d);d.error=null;return d}catch(b){try{var d=loadFirmware(a);if(d.error==null){update_memories(d)}return d}catch(b){var d=new Object();d.error="ERROR: at line: "+b.lineNumber+" and column: "+b.columnNumber;return d}}}function nextToken(d){while(("# \t\n\r".indexOf(d.text[d.t])!=-1)&&(d.t<d.text.length)){if(d.text[d.t]=="#"){while(("\n".indexOf(d.text[d.t])==-1)&&(d.t<d.text.length)){d.t++}}if(d.text[d.t]=="\n"){d.line++;d.newlines.push(d.t)}d.t++}if(("{},()=:".indexOf(d.text[d.t])!=-1)&&(d.t<d.text.length)){var a=d.text[d.t];d.t++;d.tokens.push(a);d.token_types.push("TOKEN");d.i=d.tokens.length-1;return d}if('"'==d.text[d.t]){var g=d.t;d.t++;while(('"'.indexOf(d.text[d.t])==-1)&&(d.t<d.text.length)){d.t++}d.t++;var f=d.t;var e="STRING"}else{var g=d.t;while(("{},()=:# \t\n\r".indexOf(d.text[d.t])==-1)&&(d.t<d.text.length)){d.t++}var f=d.t;var e="TOKEN"}var b=d.t;while(("# \t\n\r".indexOf(d.text[b])!=-1)&&(b<d.text.length)){if(d.text[b]=="#"){while(("\n".indexOf(d.text[b])==-1)&&(b<d.text.length)){b++}}b++}if(":"==d.text[b]){e="TAG";d.t=b+1}var a=d.text.substring(g,f);a=a.trim();if("TAG"==e){a=a+":"}d.tokens.push(a);d.token_types.push(e);d.i=d.tokens.length-1;return d}function getToken(a){return a.tokens[a.i]}function getTokenType(a){return a.token_types[a.i]}function isToken(a,b){return(getToken(a)==b.trim())}function langError(f,g){var a=0;if(f.newlines.length>0){a=f.newlines[f.newlines.length-1]+1}var d=0;if(f.newlines.length>1){d=f.newlines[f.newlines.length-2]+1}var b=d;var h=Math.min(f.t-1,a+32);for(;(typeof f.text[h+1]!="undefined")&&(f.text[h+1]!="\n");h++){}var k=h+2;h++;for(;(typeof f.text[h+1]!="undefined")&&(f.text[h+1]!="\n");h++){}h++;f.error="<pre style='background-color: inherit !important'>...\n";for(var e=b;e<h;e++){if(e==d){f.error+=" "+(f.line-1)+"\t"}if(e==a){f.error+="*"+f.line+"\t"}if(e==k){f.error+=" "+(f.line+1)+"\t"}if(typeof f.text[e]!="undefined"){f.error+=f.text[e]}else{f.error+="&lt;EOF&gt;"}}f.error+="\n...\n</pre>(*) Problem around line "+f.line+":<br>"+g+".<br>";ga("send","event","compile","error",g);return f}function read_microprg(a){var d=new Array();if(!isToken(a,"{")){return langError(a,"Expected '{' not found")}nextToken(a);while(!isToken(a,"}")){var h=new Object();if(!isToken(a,"(")){var m=getToken(a);m=m.substring(0,m.length-1);if("TAG"!=getTokenType(a)){return langError(a,"Expected '<label>:' not found but '"+m+"'.")}for(var b in a.etiquetas){if(a.etiquetas[b]==m){return langError(a,"Label is repeated: "+getToken(a))}}a.etiquetas[a.contadorMC]=m;if(m.match("[a-zA-Z_0-9]*")[0]!=m){return langError(a,"Label format is not valid for '"+getToken(a)+"'")}nextToken(a)}if(!isToken(a,"(")){return langError(a,"Expected '(' not found")}nextToken(a);while(!isToken(a,")")){var f=getToken(a).toUpperCase();if(f=="MADDR"){nextToken(a);if(!isToken(a,"=")){return langError(a,"Expected '=' not found")}nextToken(a);var n=new Object();n.nombre=getToken(a);n.cycle=d.length;n.index=a.i;n.instruction=a.instrucciones.length;var e=0;for(var g in a.etiquetas){if(isToken(a,a.etiquetas[g])){h[f]=g.toString();e=1}}if(e==0){a.labelsNotFound.push(n)}nextToken(a);if(isToken(a,",")){nextToken(a)}continue}if(typeof sim_signals[f]=="undefined"){return langError(a,"Signal does not exists: '"+f+"'")}h[f]=1;nextToken(a);if(isToken(a,"=")){nextToken(a);h[f]=parseInt(getToken(a),2);if(getToken(a).match("[01]*")[0]!=getToken(a)){return langError(a,"Incorrect binary format: "+getToken(a))}if(h[f]>=Math.pow(2,sim_signals[f].nbits)){return langError(a,"Value out of range: "+getToken(a))}nextToken(a)}if(isToken(a,",")){nextToken(a)}}d.push(h);a.contadorMC++;nextToken(a);if(isToken(a,",")){nextToken(a)}}nextToken(a);return d}function loadFirmware(n){var b=new Object();b.line=1;b.error=null;b.i=0;b.contadorMC=0;b.etiquetas=new Object();b.labelsNotFound=new Array();b.instrucciones=new Array();b.co_cop=new Object();b.registers=new Array();b.text=n;b.tokens=new Array();b.token_types=new Array();b.t=0;b.newlines=new Array();b.pseudoInstructions=new Array();b.stackRegister=null;nextToken(b);while(b.t<b.text.length){if(isToken(b,"registers")){nextToken(b);if(!isToken(b,"{")){return langError(b,"Expected '{' not found")}nextToken(b);while(!isToken(b,"}")){var d=getToken(b);nextToken(b);if(!isToken(b,"=")){return langError(b,"Expected '=' not found")}nextToken(b);b.registers[d]=getToken(b);nextToken(b);if(isToken(b,"(")){if(b.stackRegister!=null){return langError(b,"Duplicate definition of stack pointer")}nextToken(b);if(!isToken(b,"stack_pointer")){return langError(b,"Expected stack_pointer token not found")}b.stackRegister=d;nextToken(b);if(!isToken(b,")")){return langError(b,"Expected ')' not found")}nextToken(b)}if(isToken(b,",")){nextToken(b)}}nextToken(b);continue}if(isToken(b,"pseudoinstructions")){nextToken(b);if(!isToken(b,"{")){return langError(b,"Expected '{' not found")}nextToken(b);while(!isToken(b,"}")){var s=new Object();var q=new Object();q.signature="";q.name="";q.fields=new Array();q.name=getToken(b);q.signature=q.signature+getToken(b)+",";nextToken(b);while(!isToken(b,"{")){var h=new Object();h.name=getToken(b);q.fields.push(h);q.signature=q.signature+getToken(b)+",";nextToken(b);if(isToken(b,",")){nextToken(b)}}nextToken(b);q.signature=q.signature.substr(0,q.signature.length-1);s.initial=q;var y=0;var A=new Object();A.signature="";while(!isToken(b,"}")){A.signature=A.signature+getToken(b)+" ";nextToken(b)}s.finish=A;s.finish.signature=s.finish.signature.replace(";","\n");b.pseudoInstructions.push(s);nextToken(b)}nextToken(b);continue}if(isToken(b,"begin")){var o=new Object();o.name=getToken(b);o["mc-start"]=b.contadorMC;nextToken(b);var C=read_microprg(b);if(typeof C.error!="undefined"){return C}o.signature="begin";o.signatureGlobal="begin";o.microcode=C;b.instrucciones.push(o);b.contadorMC=b.contadorMC+9;continue}var o=new Object();o.name=getToken(b);o["mc-start"]=b.contadorMC;var t="";var f="";var B="";var a=0;var k=new Array();t=t+getToken(b)+",";B=getToken(b)+" ";nextToken(b);while(isToken(b,",")){nextToken(b)}while(!isToken(b,"{")){while(isToken(b,",")){nextToken(b)}var x=false;if(!isToken(b,",")&&!isToken(b,"(")&&!isToken(b,")")){var z=new Object();var p=getToken(b);if(p[p.length-1]=="+"){p=p.substring(0,p.length-1);x=true}z.name=p;k.push(z);a++;t=t+p;B=B+p;nextToken(b);if(a>100){return langError(b,"more than 100 fields in a single instruction.")}if(p=="co"){return langError(b,"instruction field has 'co' as name.")}if(p=="nwords"){return langError(b,"instruction field has 'nwords' as name.")}}if(isToken(b,"(")){t=t+",(";if(x){B=B+"("}else{B=B+" ("}nextToken(b);if(!isToken(b,",")&&!isToken(b,"(")&&!isToken(b,")")){var z=new Object();z.name=getToken(b);k.push(z);a++;t=t+getToken(b);B=B+getToken(b);nextToken(b)}else{return langError(b,"'token' is missing after '(' on: "+b.co_cop[o.co].signature)}if(isToken(b,")")){t=t+")";B=B+")";nextToken(b)}else{return langError(b,"')' is missing on: "+b.co_cop[o.co].signature)}}t=t+",";B=B+" "}t=t.substr(0,t.length-1);B=B.substr(0,B.length-1);o.signature=t;o.signatureGlobal=t;o.signatureUser=B;nextToken(b);if(!isToken(b,"co")){return langError(b,"Expected keyword 'co' not found")}nextToken(b);if(!isToken(b,"=")){return langError(b,"Expected '=' not found")}nextToken(b);o.co=getToken(b);if((getToken(b).match("[01]*")[0]!=getToken(b))||(getToken(b).length!=6)){return langError(b,"Incorrect binary format on 'co': "+getToken(b))}if((typeof b.co_cop[o.co]!="undefined")&&(b.co_cop[o.co].cop==null)){return langError(b,"'co' is already been used by: "+b.co_cop[o.co].signature)}b.co_cop[o.co]=new Object();b.co_cop[o.co].signature=o.signature;b.co_cop[o.co].cop=null;nextToken(b);if(isToken(b,",")){nextToken(b)}if(isToken(b,"cop")){nextToken(b);if(!isToken(b,"=")){return langError(b,"Expected '=' not found")}nextToken(b);o.cop=getToken(b);if((getToken(b).match("[01]*")[0]!=getToken(b))||(getToken(b).length!=4)){return langError(b,"Incorrect binary format on 'cop': "+getToken(b))}if((b.co_cop[o.co].cop!=null)&&(typeof b.co_cop[o.co].cop[o.cop]!="undefined")){return langError(b,"'co+cop' is already been used by: "+b.co_cop[o.co].cop[o.cop])}if(b.co_cop[o.co].cop==null){b.co_cop[o.co].cop=new Object()}b.co_cop[o.co].cop[o.cop]=o.signature;nextToken(b);if(isToken(b,",")){nextToken(b)}}if(!isToken(b,"nwords")){return langError(b,"Expected keyword 'nwords' not found")}nextToken(b);if(!isToken(b,"=")){return langError(b,"Expected '=' not found")}nextToken(b);o.nwords=getToken(b);nextToken(b);if(isToken(b,",")){nextToken(b)}var g=0;while(g<a){var w=getToken(b);if(k[g]["name"]!=w){return langError(b,"Unexpected field found: '"+w+"'")}nextToken(b);if(!isToken(b,"=")){return langError(b,"Expected '=' not found")}nextToken(b);if(!isToken(b,"reg")&&!isToken(b,"inm")&&!isToken(b,"address")){return langError(b,"Incorrect type of field (reg, inm or address)")}k[g]["type"]=getToken(b);t=t.replace(","+k[g]["name"],","+k[g]["type"]);t=t.replace("("+k[g]["name"],"("+k[g]["type"]);t=t.replace(")"+k[g]["name"],")"+k[g]["type"]);B=B.replace(k[g]["name"],k[g]["type"]);o.signature=t;o.signatureUser=B;f=t.replace("address","num");f=f.replace("inm","num");o.signatureGlobal=f;nextToken(b);if(!isToken(b,"(")){return langError(b,"Expected '(' not found")}nextToken(b);k[g]["startbit"]=getToken(b);if(parseInt(k[g]["startbit"])>32*parseInt(o.nwords)){return langError(b,"startbit out of range: "+getToken(b))}nextToken(b);if(!isToken(b,",")){return langError(b,"Expected ',' not found")}nextToken(b);k[g]["stopbit"]=getToken(b);if(parseInt(k[g]["stopbit"])>32*parseInt(o.nwords)){return langError(b,"stopbit out of range: "+getToken(b))}nextToken(b);if(!isToken(b,")")){return langError(b,"Expected ')' not found")}nextToken(b);if(k[g]["type"]=="address"){if(getToken(b)!="abs"&&getToken(b)!="rel"){return langError(b,"Type of addressing incorrect (abs or rel)")}k[g]["address_type"]=getToken(b);nextToken(b)}if(isToken(b,",")){nextToken(b)}g++}o.fields=k;var C=read_microprg(b);if(typeof C.error!="undefined"){return C}o.microcode=C;b.instrucciones.push(o);b.contadorMC=b.contadorMC+9;if(!isToken(b,"}")){return langError(b,"Expected '}' not found")}nextToken(b)}var m=false;for(var v=0;v<b.instrucciones.length;v++){if(b.instrucciones[v].name=="begin"){for(var u=0;u<b.instrucciones[v].microcode.length;u++){if((typeof b.etiquetas[u]!="undefined")&&(b.etiquetas[u]=="fetch")){m=true}}if(m===false){return langError(b,"label 'fetch' not defined")}}}if(m===false){return langError(b,"'begin' not found")}var e=0;if(b.labelsNotFound.length>0){for(var v=0;v<b.labelsNotFound.length;v++){for(var u in b.etiquetas){if(b.etiquetas[u]==b.labelsNotFound[v].nombre){b.instrucciones[b.labelsNotFound[v].instruction].microcode[b.labelsNotFound[v].cycle].MADDR=u;e++}}if(e==0){return langError(b,"MADDR label not found : "+b.labelsNotFound[v].nombre)}}}var C=new Object();C.error=null;C.firmware=b.instrucciones;C.labels=b.etiquetas;C.mp=new Object();C.seg=new Object();C.registers=b.registers;C.pseudoInstructions=b.pseudoInstructions;C.stackRegister=b.stackRegister;return C}function saveFirmware(a){var f="";for(var e=0;e<a.firmware.length;e++){f+=a.firmware[e].name;if(typeof a.firmware[e].fields!="undefined"){if(a.firmware[e].fields.length>0){for(var d=0;d<a.firmware[e].fields.length;d++){f+=" "+a.firmware[e].fields[d].name}}}f+=" {\n";if(typeof a.firmware[e].co!="undefined"){f+="\tco="+a.firmware[e].co+",\n"}if(typeof a.firmware[e].cop!="undefined"){f+="\tcop="+a.firmware[e].cop+",\n"}if(typeof a.firmware[e].nwords!="undefined"){f+="\tnwords="+a.firmware[e].nwords+",\n"}if(typeof a.firmware[e].fields!="undefined"){if(a.firmware[e].fields.length>0){for(var d=0;d<a.firmware[e].fields.length;d++){f+="\t"+a.firmware[e].fields[d].name+" = "+a.firmware[e].fields[d].type;f+=" ("+a.firmware[e].fields[d].startbit+","+a.firmware[e].fields[d].stopbit+")";if(a.firmware[e].fields[d].type=="address"){f+=a.firmware[e].fields[d].address_type}f+=",\n"}}}if(typeof a.firmware[e].microcode!="undefined"){var h=a.firmware[e]["mc-start"];if(a.firmware[e].name!="begin"){f+="\t{"}for(var d=0;d<a.firmware[e].microcode.length;d++){f+="\n\t\t";if(typeof a.labels[h]!="undefined"){f+=a.labels[h]+" : "}f+="( ";var g=0;for(var b in a.firmware[e].microcode[d]){if(b!="MADDR"){f+=b+"="+a.firmware[e].microcode[d][b].toString(2)+", "}else{f+=b+"="+a.labels[a.firmware[e].microcode[d][b]]+", "}g=1}if(g==1){f=f.substr(0,f.length-1)}f+="),";h++}f=f.substr(0,f.length-1);if(a.firmware[e].name!="begin"){f+="\n\t}"}}f+="\n}\n\n"}if((typeof a.registers!="undefined")&&(a.registers.length>0)){f+="registers\n{\n";for(var e=0;e<a.registers.length;e++){if(a.stackRegister==e){f+="\t$"+e+"="+a.registers[e]+" (stack_pointer),\n"}else{f+="\t$"+e+"="+a.registers[e]+",\n"}}f=f.substr(0,f.length-2);f+="\n}\n"}return f}function decode_instruction(b){var d=b.substring(0,6);var f=b.substring(28,32);var a=null;for(var e in FIRMWARE.firmware){if(FIRMWARE.firmware[e].name=="begin"){continue}if((FIRMWARE.firmware[e].co==d)&&(typeof FIRMWARE.firmware[e].cop=="undefined")){a=FIRMWARE.firmware[e];break}if((FIRMWARE.firmware[e].co==d)&&(typeof FIRMWARE.firmware[e].cop!="undefined")&&(FIRMWARE.firmware[e].cop==f)){a=FIRMWARE.firmware[e];break}}return a}function show_decode_instruction(f,h){if(null==f){return"ERROR: instruction "+h+" not found"}var b=f.name+" ";var a=f.signature.split(",");var g=parseInt(f.nwords)*32;for(var d=1;d<a.length;d++){if(((f.fields[d-1].stopbit)<(g-1))&&((f.fields[d-1].stopbit)>(g-1-32))){var e=h.substring(g-f.fields[d-1].startbit-1,g-f.fields[d-1].stopbit);if(a[d]=="reg"){b+="$"+parseInt(e,2)+" "}else{b+="0x"+parseInt(e,2).toString(16)+" "}}else{b+="... "}}return b}function decode_ram(){var d="\n";for(var a in MP){var b=MP[a].toString(2);b="00000000000000000000000000000000".substring(0,32-b.length)+b;d+="0x"+parseInt(a).toString(16)+":"+decode_instruction(b)+"\n"}return d}directives=new Object();directives[".kdata"]={name:".kdata",kindof:"segment",size:0};directives[".ktext"]={name:".ktext",kindof:"segment",size:0};directives[".data"]={name:".data",kindof:"segment",size:0};directives[".text"]={name:".text",kindof:"segment",size:0};directives[".byte"]={name:".byte",kindof:"datatype",size:1};directives[".half"]={name:".half",kindof:"datatype",size:2};directives[".word"]={name:".word",kindof:"datatype",size:4};directives[".space"]={name:".space",kindof:"datatype",size:1};directives[".ascii"]={name:".ascii",kindof:"datatype",size:1};directives[".asciiz"]={name:".asciiz",kindof:"datatype",size:1};directives[".align"]={name:".align",kindof:"datatype",size:0};function get_datatype_size(a){if(typeof directives[a]=="undefined"){console.log("data type: "+a+" is not defined!!!\n");return 0}return directives[a].size}function isTokenKindOf(b,a){if(typeof directives[b]=="undefined"){return false}return(directives[b].kindof==a)}function is_directive(a){return(typeof directives[a]!="undefined")}function is_directive_segment(a){return isTokenKindOf(a,"segment")}function is_directive_datatype(a){return isTokenKindOf(a,"datatype")}function isDecimal(a){if(a.length>1&&a[0]=="0"){return false}return(!isNaN(parseFloat(a))&&isFinite(a))?parseInt(a):false}function isOctal(d){if(d.substring(0,1)=="0"){var b=d.substring(1).replace(/\b0+/g,"");var a=parseInt(b,8);return(a.toString(8)===b)?a:false}return false}function isHex(d){if(d.substring(0,2).toLowerCase()=="0x"){var b=d.substring(2).toLowerCase().replace(/\b0+/g,"");if(b==""){b="0"}var a=parseInt(b,16);return(a.toString(16)===b)?a:false}return false}function isChar(a){if(a[0]=="'"&&a[2]=="'"){return a.charCodeAt(1)}return false}function decimal2binary(d,b){var a=(d>>>0).toString(2);if(d>=0){return[a,b-a.length]}a="1"+a.replace(/^[1]+/g,"");if(a.length>b){return[a,b-a.length]}a="1".repeat(b-a.length)+a;return[a,b-a.length]}function isValidTag(a){if(isDecimal(a[0])){return false}var b=/[^a-z\d]/i;return !(b.test(a))}function max(e,d){return e>d?e:d}function min(e,d){return e<d?e:d}function sum_array(b){return b.reduce(function(e,d){return e+d},0)}function get_candidate(f,a){var d=false;var e=new Object();var g=new Object();for(i=0;i<f.length;i++){if(f[i]){e[i]=a[i].nwords;g[a[i].signature]=0}}if(Object.keys(g).length==1){var b=false;for(i in e){if(b==false){b=e[i];d=i}else{if(b==e[i]){d=false}else{if(b>e[i]){b=e[i];d=i}}}}}return d?parseInt(d):d}function read_data(f,p,t){var e=getToken(f);var g=t.seg[e].begin;nextToken(f);var s=0;var m="00000000000000000000000000000000";while(!is_directive_segment(getToken(f))){var q="";while(!is_directive_datatype(getToken(f))){q=getToken(f);if("TAG"!=getTokenType(f)){return langError(f,"Expected tag or directive but found '"+q+"' instead")}var u=q.substring(0,q.length-1);if(!isValidTag(u)){return langError(f,"A tag must follow an alphanumeric format (starting with a letter) but found '"+u+"' instead")}if(f.firmware[u]||f.pseudoInstructions[u]){return langError(f,"A tag can not have the same name as an instruction ("+u+")")}t.labels2[u]="0x"+(g+s).toString(16);nextToken(f)}var h=getToken(f);if((".word"==h)||(".half"==h)||(".byte"==h)){nextToken(f);var k=getToken(f);while(!is_directive(getToken(f))){var a;var b=false;if((a=isOctal(k))!==false){}else{if((a=isHex(k))!==false){}else{if((a=isDecimal(k))!==false){}else{if((a=isChar(k))!==false){}else{if(".word"==h){if(!isValidTag(k)){return langError(f,"A tag must follow an alphanumeric format (starting with a letter) but found '"+k+"' instead")}if(f.firmware[k]||f.pseudoInstructions[k]){return langError(f,"A tag can not have the same name as an instruction ("+k+")")}a=0;b=true}else{return langError(f,"Expected value for numeric datatype but found '"+k+"' instead")}}}}}var o=get_datatype_size(h);var v=decimal2binary(a,o*8);num_bits=v[0];d=v[1];if(d<0){return langError(f,"Expected value that fits in a '"+h+"' ("+o*8+" bits), but inserted '"+k+"' ("+num_bits.length+" bits) instead")}if(s>=4){t.mp["0x"+g.toString(16)]=m;g=g+4;s=0;m="00000000000000000000000000000000"}while(((g+s)%o)!=0){s++;if(s>=4){t.mp["0x"+g.toString(16)]=m;g=g+4;s=0;m="00000000000000000000000000000000"}}if(""!=q){t.labels2[q.substring(0,q.length-1)]="0x"+(g+s).toString(16);q=""}if(b){t.labels["0x"+g.toString(16)]={name:k,addr:g,startbit:31,stopbit:0,rel:undefined,nwords:1}}var n=m.substring(0,m.length-8*(o+s)+d);m=n+num_bits+m.substring(m.length-8*(s));s+=o;nextToken(f);if(","==getToken(f)){nextToken(f)}if(is_directive(getToken(f))||("TAG"==getTokenType(f))||"."==getToken(f)[0]){break}k=getToken(f)}}else{if(".space"==h){nextToken(f);var k=getToken(f);if(!isDecimal(k)){return langError(f,"Expected number of bytes to reserve in .space but found '"+k+"' as number")}if(k<0){return langError(f,"Expected positive number but found '"+k+"' as positive number")}for(i=0;i<k;i++){if(s>=4){t.mp["0x"+g.toString(16)]=m;g=g+4;s=0;m="00000000000000000000000000000000"}s++}nextToken(f)}else{if(".align"==h){nextToken(f);var k=getToken(f);if(!isDecimal(k)&&k>=0){return langError(f,"Expected the align parameter as positive number but found '"+k+"'. Remember that number is the power of two for alignment, see MIPS documentation..")}if(s>=4){t.mp["0x"+g.toString(16)]=m;g=g+4;s=0;m="00000000000000000000000000000000"}var w=Math.pow(2,parseInt(k));switch(w){case 1:break;case 2:if(s&1==1){s++}break;default:while(true){if(s>=4){t.mp["0x"+g.toString(16)]=m;g=g+4;s=0;m="00000000000000000000000000000000"}if(g%w==0&&s==0){break}s++}}nextToken(f)}else{if(".ascii"==h||".asciiz"==h){nextToken(f);var k=getToken(f);while(!is_directive(getToken(f))){if(s>=4){t.mp["0x"+g.toString(16)]=m;g=g+4;s=0;m="00000000000000000000000000000000"}if(""==k){return langError(f,"String is not closed (forgot to end it with quotation marks)")}if("STRING"!=getTokenType(f)){return langError(f,"Expected string between quotation marks but found '"+k+"' instead")}for(i=0;i<k.length;i++){if(s>=4){t.mp["0x"+g.toString(16)]=m;g=g+4;s=0;m="00000000000000000000000000000000"}switch(k[i]){case'"':break;case"\\":switch(k[i+1]){case"n":num_bits="\n".charCodeAt(0).toString(2);i++;break;case"t":num_bits="\t".charCodeAt(0).toString(2);i++;break;case"0":num_bits="\0".charCodeAt(0).toString(2);i++;break;default:num_bits=k.charCodeAt(i).toString(2);break}var d=8-num_bits.length;var n=m.substring(0,m.length-8*(1+s)+d);m=n+num_bits+m.substring(m.length-8*(s));s++;break;default:num_bits=k.charCodeAt(i).toString(2);var d=8-num_bits.length;var n=m.substring(0,m.length-8*(1+s)+d);m=n+num_bits+m.substring(m.length-8*(s));s++}}if(".asciiz"==h){if(s>=4){t.mp["0x"+g.toString(16)]=m;g=g+4;s=0;m="00000000000000000000000000000000"}num_bits="\0".charCodeAt(0).toString(2);var d=8-num_bits.length;var n=m.substring(0,m.length-8*(1+s)+d);m=n+num_bits+m.substring(m.length-8*(s));s++}nextToken(f);if(","==getToken(f)){nextToken(f)}if(is_directive(getToken(f))||("TAG"==getTokenType(f))||"."==getToken(f)[0]){break}k=getToken(f)}}else{return langError(f,"UnExpected datatype name '"+h)}}}}if(f.t>=f.text.length){break}}if(s>0){t.mp["0x"+g.toString(16)]=m;g=g+4}t.seg[e].end=g}function read_text(P,b,B){var E=getToken(P);var g=B.seg[E].begin;var A=P.firmware;var v=P.pseudoInstructions;var O=new Object();for(i=0;i<b.registers.length;i++){var n="$"+i;O[n]=i;O[b.registers[i]]=O[n]}nextToken(P);while(!is_directive_segment(getToken(P))){while(typeof A[getToken(P)]=="undefined"&&typeof v[getToken(P)]=="undefined"){var d=getToken(P);if("TAG"!=getTokenType(P)){return langError(P,"Expected tag or instruction but found '"+d+"' instead")}var J=d.substring(0,d.length-1);if(!isValidTag(J)){return langError(P,"A tag must follow an alphanumeric format (starting with a letter) but found '"+J+"' instead")}if(A[J]||v[J]){return langError(P,"A tag can not have the same name as an instruction ("+J+")")}B.labels2[J]="0x"+g.toString(16);nextToken(P)}var u=getToken(P);var p=false;var L=[];var m=[];var k=[];var N=0;if(v[u]){for(i=0;i<v[u].length;i++){L[i]=v[u][i].signature.split(",");k[i]=1;p=true;N=max(N,L[i].length)}return langError(P,"Pseudoinstructions are not implemented")}var a=[];var I=[];for(i=0;i<A[u].length;i++){L[i]=A[u][i].signature.split(",");a[i]=A[u][i].signatureUser.split(" ");L[i].shift();a[i].shift();k[i]=1;I[i]=[];N=max(N,L[i].length)}var H=[];H[0]=u;for(i=0;i<N;i++){nextToken(P);if(","==getToken(P)){nextToken(P)}var G=getToken(P);var F;if("TAG"!=getTokenType(P)&&!A[G]){H[i+1]=G}for(j=0;j<k.length;j++){if(k[j]==0){continue}if(i>=L[j].length){if("TAG"!=getTokenType(P)&&!A[G]&&!v[G]){k[j]=0}continue}var h=A[u][j].fields[i];var f=h.startbit-h.stopbit+1;var t=false;switch(h.type){case"address":case"inm":if((F=isOctal(G))!==false){}else{if((F=isHex(G))!==false){}else{if((F=isDecimal(G))!==false){}else{if((F=isChar(G))!==false){}else{if(!isValidTag(G)){var x="A tag must follow an alphanumeric format (starting with a letter) but found '"+G+"' instead";k[j]=0;break}if(A[G]||v[G]){var x="A tag can not have the same name as an instruction ("+G+")";k[j]=0;break}t=true}}}}if(!t){var C=decimal2binary(F,f);if(h.type=="address"&&"rel"==h.address_type){C=decimal2binary(F-g-4,f)}}break;case"reg":var n=false;if("("==G){if("(reg)"!=L[j][i]){var x="Expected register but found register beween parenthesis";k[j]=0;break}nextToken(P);G=getToken(P);n=true}else{if("(reg)"==L[j][i]){var x="Expected register between parenthesis but found '"+G+"' instead";k[j]=0;break}}if(typeof O[G]=="undefined"){var x="Expected register ($1, ...) but found '"+G+"' instead";k[j]=0;break}if(n){H[i+1]="("+G+")";nextToken(P);if(")"!=getToken(P)){var x="String without end parenthesis ')'";k[j]=0;break}}var C=decimal2binary(isDecimal(O[G]),f);break;default:return langError(P,"An unknown error ocurred (53)")}if(k[j]==1&&!t){if(C[1]<0){if(h.type=="address"&&"rel"==h.address_type){x="Relative value ("+(F-g-4)+" in decimal) needs "+C[0].length+" bits but there is space for only "+f+" bits"}else{var x="'"+G+"' needs "+C[0].length+" bits but there is space for only "+f+" bits"}k[j]=0}}if(k[j]==1){I[j][i]={num_bits:(t?false:C[0]),num_bits_free_space:(t?false:C[1]),startbit:h.startbit,stopbit:h.stopbit,rel:(t?h.address_type:false),islabel:t,field_name:G}}}if(sum_array(k)==0){break}if("TAG"==getTokenType(P)||A[G]||v[G]){break}}var K;for(i=0;i<k.length;i++){if(k[i]==1){K=i}}var y="";for(i=0;i<A[u].length;i++){if(i>0&&i<A[u].length-1){y+=", "}if(i>0&&i==A[u].length-1){y+=" or "}y+="'"+A[u][i].signatureUser+"'"}var w=sum_array(k);if(w==0){if(k.length==1){return langError(P,x+". Remember that the instruction format has been defined as: "+y)}return langError(P,"Instruction and fields don't match with microprogram. Remember that the instruction formats have been defined as: "+y+". Please check the microcode. Probably you forgot to add a field, a number does not fit in its space, or you just used a wrong instruction")}if(w>1){K=get_candidate(k,A[u]);if(K===false){return langError(P,"Instruction and fields match with more than one microprogram. Please check the microcode. Currently, the instruction format can be: "+y)}}var o="";for(i=0;i<A[u][K].nwords;i++){o+="00000000000000000000000000000000"}if(A[u][K].co!==false){var q=o.substring(0,o.length-32);o=q+A[u][K].co+o.substring(o.length-26);if(A[u][K].cop!==false){var q=o.substring(0,o.length-4);o=q+A[u][K].cop}}for(i=0;i<I[K].length;i++){if(I[K][i].islabel){B.labels["0x"+g.toString(16)]={name:I[K][i].field_name,addr:g,startbit:I[K][i].startbit,stopbit:I[K][i].stopbit,rel:I[K][i].rel,nwords:A[u][K].nwords}}else{var D=I[K][i].startbit;var z=I[K][i].stopbit;var M=I[K][i].num_bits;var e=I[K][i].num_bits_free_space;var q=o.substring(0,o.length-1-D+e);o=q+M+o.substring(o.length-z)}}s_def=H[0];for(i=0,j=1;i<a[K].length;i++,j++){switch(a[K][i]){case"address":case"inm":case"reg":case"(reg)":s_def=s_def+" "+H[j];break;default:s_def=s_def+" "+H[j]+H[j+1];j++}}for(i=A[u][K].nwords-1;i>=0;i--){if(i<A[u][K].nwords-1){s_def="---"}B.assembly["0x"+g.toString(16)]={breakpoint:false,binary:o.substring(i*32,(i+1)*32),source:s_def,source_original:s_def};B.mp["0x"+g.toString(16)]=o.substring(i*32,(i+1)*32);g=g+4}if(N==L[K].length){nextToken(P)}if(P.t>=P.text.length){break}}B.seg[E].end=g}function simlang_compile(s,t){var b=new Object();b.line=1;b.error=null;b.i=0;b.contadorMC=0;b.etiquetas=new Object();b.labelsNotFound=new Array();b.instrucciones=new Array();b.co_cop=new Object();b.registers=new Array();b.text=s;b.tokens=new Array();b.token_types=new Array();b.t=0;b.newlines=new Array();b.pseudoInstructions=new Array();b.stackRegister=null;b.firmware=new Object();b.pseudoInstructions=new Object();for(i=0;i<t.firmware.length;i++){var d=t.firmware[i];if(typeof b.firmware[d.name]=="undefined"){b.firmware[d.name]=new Array()}b.firmware[d.name].push({name:d.name,nwords:parseInt(d.nwords),co:(typeof d.co!="undefined"?d.co:false),cop:(typeof d.cop!="undefined"?d.cop:false),fields:(typeof d.fields!="undefined"?d.fields:false),signature:d.signature,signatureGlobal:d.signatureGlobal,signatureUser:(typeof d.signatureUser!="undefined"?d.signatureUser:d.name)})}for(i=0;i<t.pseudoInstructions.length;i++){var g=t.pseudoInstructions[i].initial;var o=t.pseudoInstructions[i].finish;if(typeof b.pseudoInstructions[g.name]=="undefined"){b.pseudoInstructions[g.name]=new Array()}b.pseudoInstructions[g.name].push({name:g.name,fields:(typeof g.fields!="undefined"?g.fields:false),signature:g.signature,finish:o.signature})}var h=new Object();h.seg={".kdata":{name:".kdata",begin:0,end:255,color:"#FF99CC",kindof:"data"},".ktext":{name:".ktext",begin:256,end:4095,color:"#A9D0F5",kindof:"text"},".data":{name:".data",begin:4096,end:32767,color:"#FACC2E",kindof:"data"},".text":{name:".text",begin:32768,end:65280,color:"#BEF781",kindof:"text"},".stack":{name:".stack",begin:65535,end:65535,color:"#F1F2A3",kindof:"stack"}};h.mp=new Object();h.labels=new Object();h.labels2=new Object();h.assembly=new Object();nextToken(b);while(b.t<b.text.length){var f=getToken(b);if(typeof h.seg[f]=="undefined"){return langError(b,"Expected .data/.text/... segment but found '"+f+"' as segment")}if("data"==h.seg[f].kindof){read_data(b,t,h)}if("text"==h.seg[f].kindof){read_text(b,t,h)}if(b.error!=null){h.error=b.error;return h}}for(i in h.labels){var p=h.labels2[h.labels[i].name];if(typeof p==="undefined"){return langError(b,"Label '"+h.labels[i].name+"' used but not defined in the assembly code")}var n="";var a=h.labels[i].addr;for(j=0;j<h.labels[i].nwords;j++){n=h.mp["0x"+a.toString(16)]+n;a+=4}var u=h.labels[i].startbit-h.labels[i].stopbit+1;var q;if((q=isHex(p))!==false){var k=decimal2binary(q,u);var m="'"+h.labels[i].name+"' needs "+k[0].length+" bits but there is space for only "+u+" bits";if("rel"==h.labels[i].rel){k=decimal2binary(q-h.labels[i].addr-4,u);m="Relative value ("+(q-h.labels[i].addr-4)+" in decimal) needs "+k[0].length+" bits but there is space for only "+u+" bits"}}else{return langError(b,"Unexpected error (54)")}if(k[1]<0){return langError(b,m)}var e=n.substring(0,n.length-1-h.labels[i].startbit+k[1]);n=e+k[0]+n.substring(n.length-h.labels[i].stopbit);a=h.labels[i].addr;for(j=h.labels[i].nwords-1;j>=0;j--){h.mp["0x"+a.toString(16)]=n.substring(j*32,(j+1)*32);a+=4}}return h};